---
title: "Zebrafish Diet & Infection: Figures"
author: "Michael Sieler"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    toc: yes
    toc_depth: 3
    number_sections: yes
    theme: united
    highlight: tango
  pdf_document: 
    toc: yes
    toc_depth: '3'
    
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE, 
  # fig.width = 5, fig.height = 5,
  dpi = 300
)

# Set project path to project level
proj.path <- paste0(getwd(), "/../../")



```


```{r}

df.all %>%
  group_by(PrePostExp) %>%
  count()

```




<!-- # Main Figures -->

## Diet (4mo)

```{r}

data <- df.T0
data.alpha <- dt.alphaPlus.T0.melt
ps.obj <- ps.T0
dist <- distList.T0
data.diffAb <- diffAb.conT0

levels(data.alpha$Diet) <- factor(levels(data.alpha$Diet), levels = c("Gemma", "Watts", "ZIRC"))
data.alpha$Diet <- relevel(factor(data.alpha$Diet), ref = "Gemma")


```


### Physiology

```{r}
# Plot output settings
tmp.path <- "gg_Record/Diet_4moCtrl/Physiology"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```


#### Weight

##### Diet


```{r Diet-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Fig.1.a <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Weight
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      # caption = "",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(325, 510, 425)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 525)) + 
  theme(legend.position = "none")


Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "WilcoxonTest_Weight-Diet_4moCtrl.png"))


```

##### (SM) Sex

```{r Sex-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Sex) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Supp.Fig.1.a <- 
  data %>%
    ggplot(aes(x = Sex, 
               y = Weight
               )) +
    geom_boxplot(aes(fill = Sex)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      # caption = "",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(500)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 525)) + 
  theme(legend.position = "none")


Supp.Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Sex")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "WilcoxonTest_Weight-Sex_4moCtrl.png"))


```

#### Weight ~ Diet*Sex


```{r Diet-Physio-Weight}

test <- data %>%
  group_by(Sex) %>%
  rstatix::wilcox_test(data =., Weight ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

# # Fig.1.a <-
#   data %>%
#     ggplot(aes(x = Diet,
#                y = Weight,
#                # fill = Sex
#                )) +
#     geom_boxplot(aes(fill=Sex)) +
#     geom_quasirandom(aes(fill=Sex), shape = 21, dodge.width=.75) +
#     # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") +
#     scale_fill_manual(values = pal.Dark2) +
#     scale_color_manual(values = pal.Dark2) +
#     labs(
#       # title = "",
#       # caption = "",
#       x = "Diet",
#       y = "Weight (mg)"
#     ) +
#     ggpubr::stat_pvalue_manual(test,
#                                label = "p.adj.signif",
#                                size = 6,
#                                bracket.size = 1,
#                                y.position = c(325, 510, 425)
#                                ) +
#     scale_y_continuous(breaks = scales::breaks_pretty(n = 5),
#                        limits = c(0, 525)) +
#   theme(legend.position = "bottom")


# Fig.1.a

test %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "WilcoxonTest_Weight-Diet_4moCtrl.png"))


```

#### BCS ~ Diet*Sex


```{r Diet-Physio-Weight}

test <- data %>%
  group_by(Sex) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

# 
#   data %>%
#     ggplot(aes(x = Diet,
#                y = Body.Condition.Score,
#                # fill = Sex
#                )) +
#     geom_boxplot(aes(fill=Sex)) +
#     geom_boxplot(aes(fill=Sex)) +
#     geom_quasirandom(aes(fill=Sex), shape = 21, dodge.width=.75) +
#     # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") +
#     scale_fill_manual(values = pal.Dark2) +
#     scale_color_manual(values = pal.Dark2) +
#     labs(
#       # title = "",
#       # caption = "",
#       x = "Diet",
#       y = "Body Condition Score"
#     ) +
#     ggpubr::stat_pvalue_manual(test,
#                                label = "p.adj.signif",
#                                size = 6,
#                                bracket.size = 1,
#                                y.position = c(2.75, 3, 3.25)
#                                ) +
#     scale_y_continuous(breaks = scales::breaks_pretty(n = 5),
#                        limits = c(1, 3.25)) +
#   theme(legend.position = "bottom")
# 



test %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet*Sex")) %>%
  autofit()


```


#### Body Condition Score

##### Diet

```{r Diet-Physio-BCS}
test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")


Fig.1.b <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      # caption = "",
      x = "Diet",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(2.75, 3, 3.25)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 3.25)) + 
  theme(legend.position = "none")

Fig.1.b

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "WilcoxonTest_BCS-Diet_4moCtrl.png"))

```

##### (SM) Sex

```{r Sex-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ Sex) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Supp.Fig.1.b <- 
  data %>%
    ggplot(aes(x = Sex, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Sex)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      # caption = "",
      x = "Diet",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(4)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 4)) + 
  theme(legend.position = "none")


Supp.Fig.1.b

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Sex")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "WilcoxonTest_BCS-Sex_4moCtrl.png"))


```

### Alpha Diversity

```{r}

tmp.path <- "gg_Record/Diet_4moCtrl/Alpha"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Diet_4moCtrl/Alpha"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```


#### Diets

```{r Diet-Alpha-Diets}

# library(multcomp)
# Source: https://stats.stackexchange.com/a/60361
# Source: https://cran.r-project.org/web/packages/multcomp/vignettes/multcomp-examples.pdf

tukey.test.list <- lapply(methods.alpha, function(alpha){
  summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + Diet, 
                             data = data.alpha %>% filter(Alpha.Metric == alpha),
                             family = "quasibinomial"), 
                             linfct = mcp(Diet = "Tukey")) ) %>% 
  tidy() %>%
  separate(contrast, c('group1', 'group2'), sep = " - ") %>%
  select(-c(null.value)) %>%
  rename(p.adj = adj.p.value) %>%
  mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                  p.adj >= 0.05 ~ "ns")) %>%
  mutate(`.y.` = "Alpha.Score", .after = 1) %>%
  mutate(metric = alpha, .before = 1)
})

plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(`.y.`, group1, group2, p.adj.signif)
})

Fig.1.c <- lapply(methods.alpha, function(alpha){ 
  data.alpha %>%
  filter(Alpha.Metric == alpha) %>%
    ggplot(aes(x = Diet, 
               y = Alpha.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      caption = paste0(alpha," (4mo)"),
      x = "Diet",
      y = "Alpha Score (normalized)"
    ) +
    ggpubr::stat_pvalue_manual(plot.sig.labs[[alpha]], 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(.85, .925, 1.1)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 1.1)) + 
  theme(legend.position = "none")
})

Fig.1.c


# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-Diet_4moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-Diet_4moCtrl.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Diet), family = quasibinomial)")) %>%
  autofit()  %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-Diet_4moCtrl.png"))

```

### Beta Diversity


```{r}
tmp.path <- "gg_Record/Diet_4moCtrl/Beta"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Diet_4moCtrl/Beta"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Diets

```{r Diet-Beta-Diets}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 1,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)


Fig.1.d <- lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet),
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Diet", values = col.Diet) +
      scale_color_manual(name = "Diet", values = col.Diet)  + 
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})



Fig.1.d

stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-Diet_4moCtrl.png"))

```

#### (SM) Beta-Dispersion

```{r}

data.beta <- lapply(ord.beta, function(beta){
  
  tmp.ord <- phyloseq::ordinate(
      physeq = ps.obj, 
      method = "PCoA",  # c("DCA", "CCA", "RDA", "CAP", "DPCoA", "NMDS", "MDS", "PCoA")
      distance = beta  # c("bray", "canberra", "sor")
    )
  
  tmp.ord.data <- list()
  tmp.ord.data[[beta]] <- phyloseq::plot_ordination(
      physeq = ps.obj,
      ordination = tmp.ord,
      justDF = T
    )
  
}) %>% set_names(ord.beta)

```


##### Diet

```{r}

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% boxplot(xlab = "Diet")
  
}) 

# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-Diet_4moCtrl.png"))
                )
   })
  })
})

```

### Differential Abundance

```{r}

# Plot settings
tmp.path <- "gg_Record/Diet_4moCtrl/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8.5,
          height = 11,
          units = "in"
          )

```



#### Global


```{r}
data.diffAb <- diffAb.conT0
tax.agg = tax.agg = aggregate_taxa(ps.obj, tax.level)
tax.data = taxa.data.table(tax.agg)
# data <- data %>%
#   mutate(Diet.Time = paste0(Diet,".",Timepoint), .after = Age)

# Global

tab_w = data.diffAb$res_global[, "W", drop = FALSE]
tab_p = data.diffAb$res_global[, "p_val", drop = FALSE]
tab_q = data.diffAb$res_global[, "q_val", drop = FALSE]
tab_diff = data.diffAb$res_global[, "diff_abn", drop = FALSE]



# Log transform

samp_frac = data.diffAb$samp_frac
# Replace NA with 0
samp_frac[is.na(samp_frac)] = 0 

# Add pesudo-count (1) to avoid taking the log of 0
log_obs_abn = log(abundances(tax.agg) + 1) 

# Adjust the log observed abundances
log_obs_abn_adj = t(t(log_obs_abn) - samp_frac)

# Prep for visualization

sig_taxa = data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
  .$Taxon

df_sig = as.data.frame(t(log_obs_abn_adj[sig_taxa, ])) %>%
  tibble::rownames_to_column("Sample") %>%
  dplyr::left_join(data %>%
  tibble::rownames_to_column("Sample") %>%
                     dplyr::select(Sample, Diet),
                   by = "Sample") %>%
  dplyr::filter(!is.na(Diet)) %>%
  tidyr::pivot_longer(cols = -one_of("Sample", "Diet"), 
                      names_to = "Taxon", values_to = "value")

df_plot = df_sig %>%
  dplyr::group_by(Diet, Taxon) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::filter(!str_detect(Taxon, "^Bacteria")) %>% # Filter out unclassified taxa
  dplyr::mutate(value = round(value, 2)) %>%
  dplyr::arrange(Diet)

df_plot$Taxon = factor(df_plot$Taxon, levels = sig_taxa)


# Join higher taxanomic levels
df_plot = df_plot %>%
  rename_with(~tax.level, Taxon) %>%
  left_join(., tax.data %>% dplyr::select(-last_col()), by = tax.level)

lo = floor(min(df_plot$value))
up = ceiling(max(df_plot$value))
mid = (lo + up)/2


# Plot Heat map

p_heat_plotDiet = df_plot %>%
  ggplot(aes(x = Diet, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ .")), scales = "free", space = "free", switch = "both") +
  # facet_grid(. ~ Timepoint, scales = "free", switch="both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(Diet, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "4 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )

p_heat_plotDiet

lapply(c("pdf", "png"), function(ext){
  data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
    arrange(Taxon) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of abundant taxa (4mo, controls), sig taxa = ", length(sig_taxa))) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2-Diet_4moCtrl."
                                      ),
                            ext),  # pdf or png
                  )
})
# save_as_image(path = file.path(path.figures, tmp.path, "ANCOMBC2-Diet_4moCtrl.png"))


df_plot %>%
  select(Diet, Taxon, value) %>%
  arrange(Diet, Taxon) %>%
  select(Taxon)


```


```{r}
# Lollipop plot

# Lolliplot <-
df_plot %>%
    as.data.frame %>%
    # dplyr::select(-1) %>%
    pivot_wider(names_from = Diet, values_from = "value") %>% arrange(Taxon) %>%
    mutate(max.value = pmax(Gemma, Watts, ZIRC), # https://stackoverflow.com/a/32978686
           min.value = pmin(Gemma, Watts, ZIRC)) %>%
    mutate(direction = case_when(Gemma == max.value ~ "negative",
                                 Gemma == min.value ~ "positive",
                                 Gemma != min.value & Gemma != max.value ~ "neutral")) %>%
    mutate(mid.value = mean(max.value + min.value)) %>%
    mutate(direction = fct_relevel(direction, c("positive", "neutral", "negative"))) %>%
    
    ggplot() +
    
    geom_point(data = df_plot, aes(y = Taxon, x = value, fill = Diet), color = "Black", shape = 21, alpha=0, inherit.aes = F, guide = F) + # This disgusting line of code allows me to sneak in "PrePostExp" variables to the legend
    
    # geom_segment(aes(y=Taxon, yend=Taxon, x=`min.value`, xend=`max.value`, linetype = direction)) +
    geom_segment(aes(y=Taxon, yend=Taxon, x=`min.value`, xend=`max.value`), linetype = "solid", guide = F) +
    
    geom_point( aes(y=Taxon, x=Gemma), color = col.Diet[1], size = 3 ) +
    geom_point( aes(y=Taxon, x=Watts), color = col.Diet[2], size = 3 ) +
    geom_point( aes(y=Taxon, x=ZIRC), color = col.Diet[3], size = 3 ) +
  
    facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ .")), scales = "free", space = "free", switch="both") +
    
    # scale_color_manual(values = c(col.Diet), breaks = c("Gemma", "Watts", "ZIRC"), name = "Diet") +
    # scale_fill_manual(values = c(col.Diet), breaks = c("Gemma", "Watts", "ZIRC"), name = "Diets") +
    # scale_linetype_manual(values = c("dotted", "solid", "dashed"), name = "Ref to Diet") +
    labs(title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
         x = "Abundance (log transformed)",
         y = "Phyla")

Lolliplot

```




#### Pairwise

```{r, fig.width=8.5, fig.height=11}

# Dataframes 
data.diffAb <- diffAb.conT0
res_pair = data.diffAb$res_pair



# Sensitivity Scores

tab_sens = data.diffAb$pseudo_sens_tab
tab_sen <- tab_sens %>%
    flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Sensitivity Scores")) %>%
  autofit()

# Pairwise Analysis

df_pair = res_pair %>%
    rownames_to_column("Taxon") 

df_fig_pair = df_pair %>%
    filter(diff_DietWatts == 1 | diff_DietZIRC == 1 |
               diff_DietZIRC_DietWatts == 1) %>%
    mutate(lfc_Watts = ifelse(diff_DietWatts == 1, 
                             lfc_DietWatts, 0),
           lfc_ZIRC = ifelse(diff_DietZIRC == 1, 
                                   lfc_DietZIRC, 0),
           lfc_Watts_ZIRC = ifelse(diff_DietZIRC_DietWatts == 1, 
                                        diff_DietZIRC_DietWatts, 0)) %>%
    transmute(Taxon, 
              `Watts vs. Gemma` = round(lfc_Watts, 2), 
              `ZIRC vs. Gemma` = round(lfc_ZIRC, 2),
              `Watts vs. ZIRC` = round(lfc_Watts_ZIRC, 2)
              ) %>%
    pivot_longer(cols = `Watts vs. Gemma`:`Watts vs. ZIRC`, 
                 names_to = "group", values_to = "value") %>%
    arrange(Taxon)
df_fig_pair$group = factor(df_fig_pair$group, 
                           levels = c("Watts vs. Gemma",
                                      "ZIRC vs. Gemma",
                                      "Watts vs. ZIRC"))
  
lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = 0
fig_pair = df_fig_pair %>%
  ggplot(aes(x = group, y = Taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, 
       y = NULL, 
       title = "Log fold change of pairwise comparisons", 
       caption = "(4mo, controls)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

fig_pair


lapply(c("pdf", "png"), function(ext){
  df_pair %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of pairwise comparisons of abundant taxa (4mo, controls)")) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2-Pairwise_Diet_4moCtrl."
                                      ),
                            ext),  # pdf or png
                  )
})



# 
# 
# # Sensitivity Pairs
# 
# sens_pair = tab_sens %>%
#     rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
#       # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
#     transmute(sens_pair = `Gemma - Watts`) %>%
#     rownames_to_column("Taxon") %>%
#     left_join(df_pair %>%
#                   transmute(Taxon, 
#                             diff_pair = diff_DietWatts), 
#               by = "Taxon") %>%
#     mutate(group = "Gemma vs. Watts") %>%
#     bind_rows(
#         tab_sens %>%
#             transmute(sens_pair = `Gemma - ZIRC`) %>%
#             rownames_to_column("Taxon") %>%
#             left_join(df_pair %>%
#                           transmute(Taxon, 
#                                     diff_pair = diff_DietZIRC), 
#                       by = "Taxon") %>%
#             mutate(group = "Gemma vs. ZIRC")
#     ) %>%
#     bind_rows(
#         tab_sens %>%
#             transmute(sens_pair = `Watts - ZIRC`) %>%
#             rownames_to_column("Taxon") %>%
#             left_join(df_pair %>%
#                           transmute(Taxon, 
#                                     diff_pair = diff_DietZIRC_DietWatts), 
#                       by = "Taxon") %>%
#             mutate(group = "Watts vs. ZIRC")
#     )
# sens_pair$diff_pair = recode(sens_pair$diff_pair * 1, 
#                              `1` = "Significant",
#                              `0` = "Nonsignificant")
# sens_pair$group = factor(sens_pair$group, 
#                          levels = c("Gemma vs. Watts",
#                                     "Gemma vs. ZIRC",
#                                     "Watts vs. ZIRC"))
# 
# fig_sens_pair = sens_pair %>%
#     ggplot(aes(x = Taxon, y = sens_pair, color = diff_pair)) +
#     geom_point() +
#     scale_color_brewer(palette = "Dark2", name = NULL) +
#     facet_grid(rows = vars(group), scales = "free") +
#     labs(x = NULL, y = "Sensitivity Score",
#        caption = "(4mo, controls)") +
#     theme_bw() +
#     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
# fig_sens_pair

```




## Diet (7mo)

```{r}

data <- df.conT1
data.alpha <- dt.alphaPlus.conT1.melt
ps.obj <- ps.conT1
dist <- distList.conT1
data.diffAb <- diffAb.conT1

levels(data.alpha$Diet) <- factor(levels(data.alpha$Diet), levels = c("Gemma", "Watts", "ZIRC"))
data.alpha$Diet <- relevel(factor(data.alpha$Diet), ref = "Gemma")

```

### Physiology

```{r}
# Plot output settings
tmp.path <- "gg_Record/Diet_7moCtrl/Physiology"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Weight

##### Diet


```{r Diet-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Fig.1.a <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Weight
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(400, 600, 525)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 625)) + 
  theme(legend.position = "none")


Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-Diet_7moCtrl.png"))


```

##### (SM) Sex

```{r Sex-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Sex) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Supp.Fig.1.a <- 
  data %>%
    ggplot(aes(x = Sex, 
               y = Weight
               )) +
    geom_boxplot(aes(fill = Sex)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(500)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 525)) + 
  theme(legend.position = "none")


Supp.Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Sex")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-Sex_7moCtrl.png"))


```

#### Weight ~ Diet:Sex


```{r Diet-Physio-Weight}

test <- data %>%
  group_by(Sex) %>%
  rstatix::wilcox_test(data =., Weight ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

# Fig.1.a <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Weight,
               # fill = Sex
               )) +
    geom_boxplot(aes(fill=Sex)) +
    geom_quasirandom(aes(fill=Sex), shape = 21, dodge.width=.75) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test,
                               label = "p.adj.signif",
                               size = 6,
                               bracket.size = 1,
                               y.position = c(375, 550, 450)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5),
                       limits = c(0, 575)) +
  theme(legend.position = "bottom")


# Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet*Sex")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-DietSex_7moCtrl.png"))


```

<!-- #### BCS ~ Diet:Sex -->


<!-- ```{r Diet-Physio-Weight} -->

<!-- test <- data %>% -->
<!--   # group_by(Sex) %>% -->
<!--   rstatix::wilcox_test(data =., Body.Condition.Score ~ Diet) %>% -->
<!--   rstatix::adjust_pvalue(method = "BH") %>% -->
<!--   rstatix::add_significance("p.adj") -->


<!--   data %>% -->
<!--     ggplot(aes(x = Diet,  -->
<!--                y = Body.Condition.Score, -->
<!--                # fill = Sex -->
<!--                )) + -->
<!--     geom_boxplot(aes(fill=Sex)) + -->
<!--     geom_boxplot(aes(fill=Sex)) + -->
<!--     geom_quasirandom(aes(fill=Sex), shape = 21, dodge.width=.75) + -->
<!--     # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") +  -->
<!--     scale_fill_manual(values = pal.Dark2) + -->
<!--     scale_color_manual(values = pal.Dark2) +  -->
<!--     labs( -->
<!--       # title = "", -->
<!--       caption = "7mo, control", -->
<!--       x = "Diet", -->
<!--       y = "Body Condition Score" -->
<!--     ) + -->
<!--     ggpubr::stat_pvalue_manual(test, -->
<!--                                label = "p.adj.signif", -->
<!--                                size = 6, -->
<!--                                bracket.size = 1, -->
<!--                                y.position = c(2.75, 3, 3.25) -->
<!--                                ) + -->
<!--     scale_y_continuous(breaks = scales::breaks_pretty(n = 5), -->
<!--                        limits = c(1, 3.5)) + -->
<!--   theme(legend.position = "bottom") -->




<!-- test %>%  -->
<!--   flextable() %>% -->
<!--   align(j = 3:6, align = "right") %>% -->
<!--   colformat_double(j = 6:7, digits = 3) %>% -->
<!--   merge_v(j = 1) %>% -->
<!--   set_formatter(values = list("p" = p_val_format, -->
<!--                               "p.adj" = p_val_format) ) %>% -->
<!--   set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet")) %>% -->
<!--   autofit() %>% -->
<!--   save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_BodyCondScore-DietSex_7moCtrl.png")) -->


<!-- ``` -->


#### Body Condition Score

##### Diet

```{r Diet-Physio-BCS}
test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")


Fig.1.b <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(2.75, 3, 3.25)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 3.5)) + 
  theme(legend.position = "none")

Fig.1.b

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_BCS-Diet_7moCtrl.png"))

```

##### (SM) Sex

```{r Sex-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ Sex) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Supp.Fig.1.b <- 
  data %>%
    ggplot(aes(x = Sex, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Sex)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(4)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 4)) + 
  theme(legend.position = "none")


Supp.Fig.1.b

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Sex")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_BCS-Sex_7moCtrl.png"))


```

### Alpha Diversity

```{r}

# Plot settings
tmp.path <- "gg_Record/Diet_7moCtrl/Alpha"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Diets

```{r Diet-Alpha-Diets}

# library(multcomp)
# Source: https://stats.stackexchange.com/a/60361
# Source: https://cran.r-project.org/web/packages/multcomp/vignettes/multcomp-examples.pdf

tukey.test.list <- lapply(methods.alpha, function(alpha){
  summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + Diet, 
                             data = data.alpha %>% filter(Alpha.Metric == alpha),
                             family = "quasibinomial"), 
                             linfct = mcp(Diet = "Tukey")) ) %>% 
  tidy() %>%
  separate(contrast, c('group1', 'group2'), sep = " - ") %>%
  select(-c(null.value)) %>%
  rename(p.adj = adj.p.value) %>%
  mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                  p.adj >= 0.05 ~ "ns")) %>%
  mutate(`.y.` = "Alpha.Score", .after = 1) %>%
  mutate(metric = alpha, .before = 1)
})

plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(`.y.`, group1, group2, p.adj.signif)
})

Fig.1.c <- lapply(methods.alpha, function(alpha){ 
  data.alpha %>%
  filter(Alpha.Metric == alpha) %>%
    ggplot(aes(x = Diet, 
               y = Alpha.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      caption = paste0(alpha," (7mo)"),
      x = "Diet",
      y = "Alpha Score (normalized)"
    ) +
    ggpubr::stat_pvalue_manual(plot.sig.labs[[alpha]], 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(.85, .925, 1.1)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 1.1)) + 
  theme(legend.position = "none")
})

Fig.1.c


# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM-Mod_Alpha-Diet_7moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-Diet_7moCtrl.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Diet), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-Diet_7moCtrl.png"))

```


### Beta Diversity

```{r}

# Plot settings
tmp.path <- "gg_Record/Diet_7moCtrl/Beta"
gg_record(dir = file.path(path.figures, "gg_Record/Diet_7moCtrl/Beta"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Diets

```{r Diet-Beta-Diets}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 1,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)



# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)


Fig.1.d <- lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  # cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  # cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])
  cap.min <- -3
  cap.max <- 1.5

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet),
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Diet", values = col.Diet) +
      scale_color_manual(name = "Diet", values = col.Diet)  + 
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = paste0(beta, " (7mo)")) + 
      theme(legend.position = "bottom")
})



Fig.1.d

stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-Diet_7moCtrl.png"))

```

#### (SM) Beta-Dispersion

```{r}
ord.beta <- c("bray", "canberra")

data.beta <- lapply(ord.beta, function(beta){
  
  tmp.ord <- phyloseq::ordinate(
      physeq = ps.obj, 
      method = "PCoA",  # c("DCA", "CCA", "RDA", "CAP", "DPCoA", "NMDS", "MDS", "PCoA")
      distance = beta  # c("bray", "canberra", "sor")
    )
  
  tmp.ord.data <- list()
  tmp.ord.data[[beta]] <- phyloseq::plot_ordination(
      physeq = ps.obj,
      ordination = tmp.ord,
      justDF = T
    )
  
}) %>% set_names(ord.beta)

```


##### Diet

```{r, fig.width=5, fig.height=5}

# Beta-dispersion Table
ord.beta <- c("bray", "canberra")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% boxplot(xlab = "Diet")
  
}) 

# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-Diet_7moCtrl.png"))
                )
   })
  })
})
```


### Differential Abundance

```{r}

# Plot settings
tmp.path <- "gg_Record/Diet_7moCtrl/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8.5,
          height = 11,
          units = "in"
          )

```


#### Global

```{r}

tax.agg = tax.agg = aggregate_taxa(ps.obj, tax.level)
tax.data = taxa.data.table(tax.agg)

# Global

tab_w = data.diffAb$res_global[, "W", drop = FALSE]
tab_p = data.diffAb$res_global[, "p_val", drop = FALSE]
tab_q = data.diffAb$res_global[, "q_val", drop = FALSE]
tab_diff = data.diffAb$res_global[, "diff_abn", drop = FALSE]

# Log transform

samp_frac = data.diffAb$samp_frac
# Replace NA with 0
samp_frac[is.na(samp_frac)] = 0 

# Add pesudo-count (1) to avoid taking the log of 0
log_obs_abn = log(abundances(tax.agg) + 1) 

# Adjust the log observed abundances
log_obs_abn_adj = t(t(log_obs_abn) - samp_frac)

# Prep for visualization

sig_taxa = data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
  .$Taxon

df_sig = as.data.frame(t(log_obs_abn_adj[sig_taxa, ])) %>%
  tibble::rownames_to_column("Sample") %>%
  dplyr::left_join(data %>%
  tibble::rownames_to_column("Sample") %>%
                     dplyr::select(Sample, Diet),
                   by = "Sample") %>%
  dplyr::filter(!is.na(Diet)) %>%
  tidyr::pivot_longer(cols = -one_of("Sample", "Diet"), 
                      names_to = "Taxon", values_to = "value")

df_plot = df_sig %>%
  dplyr::group_by(Diet, Taxon) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::filter(!str_detect(Taxon, "^Bacteria")) %>% # Filter out unclassified taxa
  dplyr::mutate(value = round(value, 2)) %>%
  dplyr::arrange(Diet)
df_plot$Taxon = factor(df_plot$Taxon, levels = sig_taxa)

# Join higher taxanomic levels
df_plot = df_plot %>%
  rename_with(~tax.level, Taxon) %>%
  left_join(., tax.data %>% dplyr::select(-last_col()), by = tax.level)

lo = floor(min(df_plot$value))
up = ceiling(max(df_plot$value))
mid = (lo + up)/2


# Plot Heat map

p_heat_diet = df_plot %>%
  ggplot(aes(x = Diet, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ .")), scales = "free", space = "free", switch = "both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(Diet, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "7 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )

p_heat_diet



lapply(c("pdf", "png"), function(ext){
  data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
    arrange(Taxon) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of abundant taxa (4mo, controls), sig taxa = ", length(sig_taxa))) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2-Diet_7moCtrl."
                                      ),
                            ext),  # pdf or png
                  )
})


```



#### Pairwise

```{r, fig.width=8.5, fig.height=11}

# Dataframes 
res_pair = data.diffAb$res_pair



# Sensitivity Scores

tab_sens = data.diffAb$pseudo_sens_tab
tab_sen <- tab_sens %>%
    flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Sensitivity Scores")) %>%
  autofit()

# Pairwise Analysis

df_pair = res_pair %>%
    rownames_to_column("Taxon") 

df_fig_pair = df_pair %>%
    filter(diff_DietWatts == 1 | diff_DietZIRC == 1 |
               diff_DietZIRC_DietWatts == 1) %>%
    mutate(lfc_Watts = ifelse(diff_DietWatts == 1, 
                             lfc_DietWatts, 0),
           lfc_ZIRC = ifelse(diff_DietZIRC == 1, 
                                   lfc_DietZIRC, 0),
           lfc_Watts_ZIRC = ifelse(diff_DietZIRC_DietWatts == 1, 
                                        diff_DietZIRC_DietWatts, 0)) %>%
    transmute(Taxon, 
              `Gemma vs. Watts` = round(lfc_Watts, 2), 
              `Gemma vs. ZIRC` = round(lfc_ZIRC, 2),
              `Watts vs. ZIRC` = round(lfc_Watts_ZIRC, 2)
              ) %>%
    pivot_longer(cols = `Gemma vs. Watts`:`Watts vs. ZIRC`, 
                 names_to = "group", values_to = "value") %>%
    arrange(Taxon)
df_fig_pair$group = factor(df_fig_pair$group, 
                           levels = c("Gemma vs. Watts",
                                      "Gemma vs. ZIRC",
                                      "Watts vs. ZIRC"))
  
lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = 0
fig_pair = df_fig_pair %>%
  ggplot(aes(x = group, y = Taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, 
       y = NULL, 
       title = "Log fold change of pairwise comparisons",
       caption = "(4mo, controls)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

fig_pair



# Sensitivity Pairs

sens_pair = tab_sens %>%
    rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    transmute(sens_pair = `Gemma - Watts`) %>%
    rownames_to_column("Taxon") %>%
    left_join(df_pair %>%
                  transmute(Taxon, 
                            diff_pair = diff_DietWatts), 
              by = "Taxon") %>%
    mutate(group = "Gemma vs. Watts") %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Gemma - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC), 
                      by = "Taxon") %>%
            mutate(group = "Gemma vs. ZIRC")
    ) %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Watts - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC_DietWatts), 
                      by = "Taxon") %>%
            mutate(group = "Watts vs. ZIRC")
    )
sens_pair$diff_pair = recode(sens_pair$diff_pair * 1, 
                             `1` = "Significant",
                             `0` = "Nonsignificant")
sens_pair$group = factor(sens_pair$group, 
                         levels = c("Gemma vs. Watts",
                                    "Gemma vs. ZIRC",
                                    "Watts vs. ZIRC"))

fig_sens_pair = sens_pair %>%
    ggplot(aes(x = Taxon, y = sens_pair, color = diff_pair)) +
    geom_point() +
    scale_color_brewer(palette = "Dark2", name = NULL) +
    facet_grid(rows = vars(group), scales = "free") +
    labs(x = NULL, y = "Sensitivity Score",
       caption = "(4mo, controls)") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
fig_sens_pair

```




## Development

```{r}

data <- df.conT0T1
data.alpha <- dt.alphaPlus.conT0T1.melt
ps.obj <- ps.conT0T1
dist <- distList.conT0T1
# data.diffAb <- diffAb.conT0T1_DietTime
# data.diffAb <- diffAb.conT0T1_Time

levels(data.alpha$Timepoint) <- factor(levels(data.alpha$Timepoint), levels = c("4mpf", "7mpf"))
data.alpha$Timepoint <- relevel(factor(data.alpha$Timepoint), ref = "4mpf")

levels(data$Timepoint) <- factor(levels(data$Timepoint), levels = c("4mpf", "7mpf"))
data$Timepoint <- relevel(factor(data$Timepoint), ref = "4mpf")

```

### Alpha Diversity

```{r}

tmp.path <- "gg_Record/Dev_4mo7moCtrl/Alpha"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Dev_4mo7moCtrl/Alpha"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Time

```{r Dev-Alpha-Time}


tukey.test.list <- lapply(methods.alpha, function(alpha){
  summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + Timepoint, 
                             data = data.alpha %>% filter(Alpha.Metric == alpha),
                             family = "quasibinomial"), 
                             linfct = mcp(Timepoint = "Tukey")) ) %>% 
  tidy() %>%
  separate(contrast, c('group1', 'group2'), sep = " - ") %>%
  select(-c(null.value)) %>%
  rename(p.adj = adj.p.value) %>%
  mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                  p.adj >= 0.05 ~ "ns")) %>%
  mutate(`.y.` = "Alpha.Score", .after = 1) %>%
  mutate(metric = alpha, .before = 1)
})

plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(`.y.`, group1, group2, p.adj.signif)
})


Fig.2.a <-
  data.alpha %>%
  filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Timepoint, 
               y = Alpha.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    # facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = pal.Dark2[c(6,4)]) +
    scale_color_manual(values = pal.Dark2[c(6,4)]) +
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Alpha Score (normalized)"
    ) +
    ggpubr::stat_pvalue_manual(plot.sig.labs[["Shannon"]], 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(1.075)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5),
                       limits = c(0, 1.1)) +
  theme(legend.position = "none")

Fig.2.a


# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Timepoint",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(2,4), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Time), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-Diet_4-7moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Time), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-Diet_4-7moCtrl.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Timepoint), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-Diet_4-7moCtrl.png"))

```

#### Time:Diets


```{r Dev-Alpha-TimeDiets}

tukey.test.list <- lapply(methods.alpha, function(alpha){
  test <- data.alpha %>%
    filter(Alpha.Metric == alpha) %>%
    group_by(Diet) %>%
    nest(data = -Diet) %>%
    mutate(test = map(.x=data, 
                      ~summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + Timepoint, 
                           data = .x,
                           family = "quasibinomial"), 
                           linfct = mcp(Timepoint = "Tukey")) )%>% tidy
                      )) %>%
    unnest(test) %>%
    separate(contrast, c('group1', 'group2'), sep = " - ") %>%
    select(-c(data, null.value)) %>%
    rename(p.adj = adj.p.value) %>%
    mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                    p.adj >= 0.05 ~ "ns")) %>%
    mutate(`.y.` = "Alpha.Score", .after = 1) %>%
    arrange(Diet)%>%
  mutate(metric = alpha, .before = 1)
})



plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(Diet, `.y.`, group1, group2, p.adj.signif)
})


Fig.2.b <- lapply(methods.alpha, function(alpha){ 
  data.alpha %>%
  filter(Alpha.Metric == alpha) %>%
    ggplot(aes(x = Timepoint, 
               y = Alpha.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Diet) +
    # scale_color_manual(values = pal.Set1) +
    labs(
      # title = "",
      caption = alpha,
      x = "Time",
      y = "Alpha Score (normalized)"
    ) +
    ggpubr::stat_pvalue_manual(plot.sig.labs[[alpha]], 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(.95, .95, 1.075)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5),
                       limits = c(0, 1.1)) +
  theme(legend.position = "none")

})
  
Fig.2.b

# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet*Timepoint",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(6, 12), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet*Time), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-DietTime_4-7moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet*Time), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-DietTime_4-7moCtrl.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Diet:Timepoint), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-DietTime_4-7moCtrl.png"))


```

### Beta Diversity

```{r}
tmp.path <- "gg_Record/Dev_4mo7moCtrl/Beta"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Dev_4mo7moCtrl/Beta"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Diet

```{r Dev-Beta-Diets}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 1,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)

# lapply(methods.beta, function(beta){
# 
# p.val <- anova$p.value[anova$metric == beta][1]
# p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
# cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
# cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])
# 
# 
#   dt.ord.full.beta[[beta]]$sample.coords %>%
#     ggplot(aes(x = .[[2]], y = .[[3]])) +
#       stat_ellipse(aes(color = Diet )) +
#       geom_point(aes(color = Diet),
#                  size = 2.5,
#                  alpha = 1) +
#       annotate("text", 
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(values = col.Diet) +
#       scale_color_manual(values = col.Diet)  + 
#       labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# })



# Fig.2.c <- lapply(methods.beta, function(beta){
# 
# p.val <- anova$p.value[anova$metric == beta][1]
# p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
# cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
# cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])
# 
# 
#   dt.ord.full.beta[[beta]]$sample.coords %>%
#     ggplot(aes(x = .[[2]], y = .[[3]])) +
#       stat_ellipse(aes(color = Timepoint )) +
#       geom_point(aes(color = Timepoint),
#                  size = 2.5,
#                  alpha = 1) +
#       annotate("text", 
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(values = col.Time) +
#       scale_color_manual(values = col.Time)  + 
#       labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# })

lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet,
                     shape = Timepoint),
                 stroke = 1,
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Time", values = col.Diet) +
      scale_color_manual(name = "Time", values = col.Diet)  + 
      scale_shape_manual(name = "Time", values = c(19, 1)) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})

# Fig.2.c.3 <- lapply(methods.beta, function(beta){
# 
# p.val <- anova$p.value[anova$metric == beta][1]
# p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
# cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
# cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])
# 
# 
#   dt.ord.full.beta[[beta]]$sample.coords %>%
#     ggplot(aes(x = .[[2]], y = .[[3]])) +
#       stat_ellipse(aes(color = Diet )) +
#       geom_point(aes(color = Diet, fill = Timepoint),
#                  shape = 21,
#                  size = 2.5,
#                  stroke = 1.25,
#                  alpha = 1) +
#       annotate("text", 
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(name = "Time", values = col.Time) +
#       scale_color_manual(name = "Diet",values = col.Diet)  + 
#       labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# })



stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-Diet_4-7moCtrl.png"))


```



#### Time

```{r Dev-Beta-Time}


# Full dbRDA models
mod <- full_dbrda_model(vars = c("Timepoint"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 1,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)

# lapply(methods.beta, function(beta){
# 
#   p.val <- anova$p.value[anova$metric == beta][1]
#   p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
#   cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
#   cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])
# 
#   dt.ord.full.beta[[beta]]$sample.coords %>%
#     ggplot(aes(x = .[[2]], y = .[[3]])) +
#       stat_ellipse(aes(color = Diet, linetype = Timepoint )) +
#       geom_point(aes(color = Diet,
#                      shape = Timepoint),
#                  size = 2.5,
#                  alpha = 1) +
#       annotate("text", 
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(name = "Time", values = col.Time) +
#       scale_color_manual(name = "Diet", values = col.Diet)  + 
#       scale_shape_manual(name = "Time", values = c(19, 1)) +
#       scale_linetype_manual(name = "Time", values = c("solid", "dashed")) +
#       labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# })



lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet,
                     shape = Timepoint),
                 stroke = 1,
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Time", values = col.Diet) +
      scale_color_manual(name = "Time", values = col.Diet)  + 
      scale_shape_manual(name = "Time", values = c(19, 1)) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})





stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Time")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-Time_4-7moCtrl.png"))

```


#### Diets:Time


```{r}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Diet", "Timepoint"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 2,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
beta.metric <- 'Bray-Curtis'
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)



lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet,
                     shape = Timepoint),
                 stroke = 1,
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Time", values = col.Diet) +
      scale_color_manual(name = "Time", values = col.Diet)  + 
      scale_shape_manual(name = "Time", values = c(19, 1)) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})



# 
# Fig.2.x.1 <- lapply(methods.beta, function(beta){
#   
#   p.val <- anova$p.value[anova$metric == beta][1]
#   p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
#   cap.min <- min(dt.ord.full.beta[[beta.metric]]$sample.coords[[3]])
#   cap.max <- max(dt.ord.full.beta[[beta.metric]]$sample.coords[[2]])
# 
# 
#   dt.ord.full.beta[[beta.metric]]$sample.coords %>%
#     ggplot(aes(x = CAP1, y = CAP2)) +
#       stat_ellipse(aes(color = Diet, linetype = Timepoint )) +
#       geom_point(aes(color = Diet,
#                      shape = Timepoint),
#                  # shape = 21,
#                  size = 2.5,
#                  alpha = 1) +
#       annotate("text", 
#                # label = paste0(beta.metric, "; ", p.val.label),
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(name = "Diet", values = pal.Dark2) +
#       scale_color_manual(name = "Diet", values = pal.Dark2)  + 
#       scale_shape_manual(name = "Time", values = c(19, 1)) +
#       labs(x = dt.ord.full.beta[[beta.metric]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta.metric]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# 
# })
#   
# Fig.2.x.1
# 
# Fig.2.x.2 <- lapply(methods.beta, function(beta){
#   
#   p.val <- anova$p.value[anova$metric == beta.metric][1]
#   p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
#   cap.min <- min(dt.ord.full.beta[[beta.metric]]$sample.coords[[3]])
#   cap.max <- max(dt.ord.full.beta[[beta.metric]]$sample.coords[[2]])
# 
# 
#   dt.ord.full.beta[[beta.metric]]$sample.coords %>%
#     ggplot(aes(x = .[[2]], y = .[[3]])) +
#       stat_ellipse(aes(color = Timepoint, linetype = Diet )) +
#       geom_point(aes(color = Timepoint,
#                      fill = Timepoint,
#                      shape = Diet
#                      ),
#                  # shape = 21,
#                  size = 2.5,
#                  alpha = 1) +
#       annotate("text", 
#                # label = paste0(beta.metric, "; ", p.val.label),
#                label = p.val.label,
#                x = cap.max, y = cap.min, 
#                size = 5, 
#                color = "black",
#                hjust = .95
#       ) +
#       scale_fill_manual(name = "Diet", values = col.Time) +
#       scale_color_manual(name = "Diet", values = col.Time)  + 
#       # scale_shape_manual(name = "Time", values = c(19, 1)) +
#       labs(x = dt.ord.full.beta[[beta.metric]]$axes.labs[1], 
#            y = dt.ord.full.beta[[beta.metric]]$axes.labs[2],
#            caption = beta) + 
#       theme(legend.position = "bottom")
# 
# })
#   
# Fig.2.x.2


stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diet*Time")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-DietTime_4-7moCtrl.png"))

```





#### (SM) Beta-Dispersion

```{r}
ord.beta <- c("bray", "canberra", "sor")

data.beta <- lapply(ord.beta, function(beta){
  
  tmp.ord <- phyloseq::ordinate(
      physeq = ps.obj, 
      method = "PCoA",  # c("DCA", "CCA", "RDA", "CAP", "DPCoA", "NMDS", "MDS", "PCoA")
      distance = beta  # c("bray", "canberra", "sor")
    )
  
  tmp.ord.data <- list()
  tmp.ord.data[[beta]] <- phyloseq::plot_ordination(
      physeq = ps.obj,
      ordination = tmp.ord,
      justDF = T
    )
  
}) %>% set_names(ord.beta)

```


##### Diet

```{r, fig.width=5, fig.height=5}

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Diet)  %>% boxplot(xlab = "Diet")
  
}) 

# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-Diet_4-7moCtrl.png"))
                )
   })
  })
})
```


##### Time

```{r, fig.width=5, fig.height=5}

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Timepoint)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = data$Timepoint)  %>% boxplot(xlab = "Time")
  
}) 

# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-Time_4-7moCtrl.png"))
                )
   })
  })
})
```

##### Diet:Time (all)

```{r}

# Add interaction
tmp.data <- data %>%
  mutate(Diet.Time = paste0(Diet,".", Timepoint), .after = Age)

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Diet.Time)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Diet.Time)  %>% boxplot(col = col.Diet[c(1,1,2,2,3,3)],
                                                        xlab = "Time")
  
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <- lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    filter(`p-value` < .1) %>%
    arrange(`p-value`) %>%
    flextable() %>%
  set_caption(paste0("filtered p-value < 0.1"))
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl.png"))
                )
   })
  })
})

```


##### Diet:Time (per diet)

###### Gemma

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "Gemma")

dist <- distList.conT0T1.Gemma

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Timepoint)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Time)  %>% boxplot(col = col.Diet[1],
                                                        xlab = "Time (Gemma)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_Gemma.png"))
                )
   })
  })
})


```


###### Watts

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "Watts")

dist <- distList.conT0T1.Watts

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Timepoint)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Time)  %>% boxplot(col = col.Diet[2],
                                                        xlab = "Time (Watts)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_Watts.png"))
                )
   })
  })
})


```



###### ZIRC

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "ZIRC")

dist <- distList.conT0T1.ZIRC

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Timepoint)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$Time)  %>% boxplot(col = col.Diet[3],
                                                        xlab = "Time (ZIRC)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_ZIRC.png"))
                )
   })
  })
})


```




### Physiology

```{r}

tmp.path <- "gg_Record/Dev_4mo7moCtrl/Physiology"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Dev_4mo7moCtrl/Physiology"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### BCS ~ Diet*Time

```{r}

data %>% 
  lm(data = ., formula = Body.Condition.Score ~ Timepoint*Diet, na.action = "na.exclude") %>%
  anova() %>%
  tidy() %>%
    mutate(sig = ifelse(p.value <= 0.05, "*", ""))%>% 
  flextable() %>%
  align(align = "right") %>%
  colformat_double( digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.value" = p_val_format) ) %>%
  set_caption(paste0("ANOVA. p. adj: BH. Body.Condition.Score ~ Diet*Time")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "LM_BCS-DietTime_4-7mo.png"))



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Timepoint, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Time) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    # ggpubr::stat_pvalue_manual(test, 
    #                            label = "p.adj.signif", 
    #                            size = 6,
    #                            bracket.size = 1,
    #                            y.position = c(3, 3.3, 3.6,
    #                                           3, 3.3, 3.6,
    #                                           3.5, 3.8, 4.15)
    #                            ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")

  
  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Diet, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Timepoint, scale = "free") +
    scale_fill_manual(values = col.Diet) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    # ggpubr::stat_pvalue_manual(test, 
    #                            label = "p.adj.signif", 
    #                            size = 6,
    #                            bracket.size = 1,
    #                            y.position = c(3, 3.3, 3.6,
    #                                           3, 3.3, 3.6,
    #                                           3.5, 3.8, 4.15)
    #                            ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")


```



#### Weight ~ Diet*Time

```{r Dev-Physio-BCS}

test <- data %>%
  # filter(Alpha.Metric == "Shannon") %>%
  group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Timepoint) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Timepoint, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = pal.Dark2[c(6,4)]) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(2.65, 2.75, 3.55)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 3.75)) + 
  theme(legend.position = "none")


test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet:Time")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-Diet_7moCtrl.png"))

```


#### BCS ~ Alpha Diversity

```{r}





# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet*Body.Condition.Score",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(6, 12), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet*Body.Condition.Score), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_BCS~AlphaDiet_4-7moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet*Body.Condition.Score), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_BCS~AlphaDiet_4-7moCtrl.png"))



```


#### ZIRC BCS ~ Alpha Diversity

```{r}

test.list <- lapply(methods.alpha, function(alpha){
  
  lapply(c("Gemma", "Watts", "ZIRC"), function(diet){
        glm(formula = Alpha.Score ~ Body.Condition.Score, 
               data = data.alpha %>% filter(Alpha.Metric == alpha & Diet == diet),
               family = "quasibinomial") %>% 
  Anova(type = 2) %>%
  tidy() %>% 
  mutate(term = c(paste0("Body Condition Score (", diet, ")")), 
         `.y.` = c("Alpha.Score"), 
         .before = 1,
         Diet = diet) %>%
  mutate(metric = alpha, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
    
  })
}) %>% bind_rows()

# test <- data.alpha %>%
#   filter(Alpha.Metric == "Shannon" & Diet == "ZIRC") %>%
#   # group_by(Diet) %>%
#   rstatix::anova_test(data =., Body.Condition.Score ~ Alpha.Score) %>%
#   rstatix::adjust_pvalue(method = "BH") %>%
#   rstatix::add_significance("p.adj")

plot.label <- lapply(methods.alpha, function(alpha){ 
    lapply(c("Gemma", "Watts", "ZIRC"), function(diet){
      paste0("F = ", round(test.list[[alpha]]$statistic, 3), "; P = ", round(test.list[[alpha]]$p.value, 3))
  })
})


## Plots need some work with the captions


  data.alpha %>%
  filter(Alpha.Metric == "Simpson" & Diet == "ZIRC") %>%
    ggplot(aes(y = Alpha.Score, 
               x = Body.Condition.Score)
           ) +
    geom_smooth(aes(color = Diet, 
                    fill = Diet), 
                method = "lm") +
    geom_point(size = 2.5) +
    # facet_grid(. ~ Diet, scale = "free") +
    annotate("text", 
               label = plot.label[["Simpson"]],
               x = 3.5, y = 0.05, 
               size = 5, 
               color = "black",
               hjust = 1
      ) +
    scale_fill_manual(values = pal.Dark2[3]) +
    scale_color_manual(values = pal.Dark2[3]) + 
    labs(
      # title = "",
      # caption = "",
      y = "Alpha Score (normalized)",
      x = "Body Condition Score"
    ) +
    theme(legend.position = "none")

  
  data.alpha %>%
  filter(Alpha.Metric == "Observed" & Diet == "Watts") %>%
    ggplot(aes(y = Alpha.Score, 
               x = Body.Condition.Score)
           ) +
    geom_smooth(aes(color = Diet, 
                    fill = Diet), 
                method = "lm") +
    geom_point(size = 2.5) +
    # facet_grid(. ~ Diet, scale = "free") +
    annotate("text", 
               label = plot.label[["Observed"]],
               x = 3.5, y = 0.05, 
               size = 5, 
               color = "black",
               hjust = 1
      ) +
    scale_fill_manual(values = pal.Dark2[3]) +
    scale_color_manual(values = pal.Dark2[3]) + 
    labs(
      # title = "",
      # caption = "",
      y = "Alpha Score (normalized)",
      x = "Body Condition Score"
    ) +
    theme(legend.position = "none")



test.list %>%
  bind_rows() %>%
  flextable() %>%
  # align(j = 3:6, align = "right") %>%
  colformat_double(j = 4, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Body.Condition.Score), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-BCS-Diet_4-7moCtrl.png"))

```

#### Beta ~ BCS*Diet


```{r Dev-Beta-BCS}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Body.Condition.Score","Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 2,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
beta.metric <- 'Bray-Curtis'
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)



lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet,
                     shape = Timepoint,
                     size = Body.Condition.Score),
                 stroke = 1,
                 # size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Time", values = col.Diet) +
      scale_color_manual(name = "Time", values = col.Diet)  + 
      scale_shape_manual(name = "Time", values = c(19, 1)) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})

stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Body.Condition.Score*Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-BCS-Diet_4-7moCtrl.png"))


```


### Differential Abundance

```{r}

# Plot settings
tmp.path <- "gg_Record/dev_4mo7moCtrl/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8.5,
          height = 11,
          units = "in"
          )

```


#### Global

```{r}

data.diffAb <- diffAb.conT0T1_DietTime
tax.agg = tax.agg = aggregate_taxa(ps.obj, tax.level)
tax.data = taxa.data.table(tax.agg)
data <- data %>%
  mutate(Diet.Time = paste0(Diet,".",Timepoint), .after = Age)

# Global

tab_w = data.diffAb$res_global[, "W", drop = FALSE]
tab_p = data.diffAb$res_global[, "p_val", drop = FALSE]
tab_q = data.diffAb$res_global[, "q_val", drop = FALSE]
tab_diff = data.diffAb$res_global[, "diff_abn", drop = FALSE]

# Log transform

samp_frac = data.diffAb$samp_frac
# Replace NA with 0
samp_frac[is.na(samp_frac)] = 0 

# Add pesudo-count (1) to avoid taking the log of 0
log_obs_abn = log(abundances(tax.agg) + 1) 

# Adjust the log observed abundances
log_obs_abn_adj = t(t(log_obs_abn) - samp_frac)

# Prep for visualization

sig_taxa = data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
  .$Taxon

df_sig = as.data.frame(t(log_obs_abn_adj[sig_taxa, ])) %>%
  tibble::rownames_to_column("Sample") %>%
  dplyr::left_join(data %>%
  tibble::rownames_to_column("Sample") %>%
                     dplyr::select(Sample, Diet, Timepoint, Diet.Time),
                   by = "Sample") %>%
  dplyr::filter(!is.na(Diet)) %>%
  tidyr::pivot_longer(cols = -one_of("Sample", "Diet", "Timepoint", "Diet.Time"), 
                      names_to = "Taxon", values_to = "value")

df_plot = df_sig %>%
  dplyr::group_by(Diet.Time, Diet, Timepoint, Taxon) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::filter(!str_detect(Taxon, "^Bacteria")) %>% # Filter out unclassified taxa
  dplyr::mutate(value = round(value, 2)) %>%
  dplyr::arrange(Diet)

df_plot$Taxon = factor(df_plot$Taxon, levels = sig_taxa)


# Join higher taxanomic levels
df_plot = df_plot %>%
  rename_with(~tax.level, Taxon) %>%
  left_join(., tax.data %>% dplyr::select(-last_col()), by = tax.level)

lo = floor(min(df_plot$value))
up = ceiling(max(df_plot$value))
mid = (lo + up)/2


# Plot Heat map

p_heat_plotDiet = df_plot %>%
  ggplot(aes(x = Diet, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ Timepoint")), scales = "free", space = "free", switch = "both") +
  # facet_grid(. ~ Timepoint, scales = "free", switch="both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(Diet, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "4 & 7 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )


p_heat_plotTime = df_plot %>%
  ggplot(aes(x = Timepoint, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ Diet")), scales = "free", space = "free", switch = "both") +
  # facet_grid(. ~ Diet, scales = "free", switch="both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(Timepoint, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "4 & 7 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )


p_heat_plotDiet
p_heat_plotTime



lapply(c("pdf", "png"), function(ext){
  data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
    arrange(Taxon) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of abundant taxa (4-7mpf, controls), sig taxa = ", length(sig_taxa))) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2_Weight-Diet_4-7moCtrl."
                                      ),
                            ext),  # pdf or png
                  )
})


```



#### Pairwise

```{r, fig.width=8.5, fig.height=11}

# Dataframes 
res_pair = data.diffAb$res_pair



# Sensitivity Scores

tab_sens = data.diffAb$pseudo_sens_tab
tab_sen <- tab_sens %>%
    flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Sensitivity Scores")) %>%
  autofit()

# Pairwise Analysis

df_pair = res_pair %>%
    rownames_to_column("Taxon") 

df_fig_pair = df_pair %>%
    filter(diff_DietWatts == 1 | diff_DietZIRC == 1 |
               diff_DietZIRC_DietWatts == 1) %>%
    mutate(lfc_Watts = ifelse(diff_DietWatts == 1, 
                             lfc_DietWatts, 0),
           lfc_ZIRC = ifelse(diff_DietZIRC == 1, 
                                   lfc_DietZIRC, 0),
           lfc_Watts_ZIRC = ifelse(diff_DietZIRC_DietWatts == 1, 
                                        diff_DietZIRC_DietWatts, 0)) %>%
    transmute(Taxon, 
              `Gemma vs. Watts` = round(lfc_Watts, 2), 
              `Gemma vs. ZIRC` = round(lfc_ZIRC, 2),
              `Watts vs. ZIRC` = round(lfc_Watts_ZIRC, 2)
              ) %>%
    pivot_longer(cols = `Gemma vs. Watts`:`Watts vs. ZIRC`, 
                 names_to = "group", values_to = "value") %>%
    arrange(Taxon)
df_fig_pair$group = factor(df_fig_pair$group, 
                           levels = c("Gemma vs. Watts",
                                      "Gemma vs. ZIRC",
                                      "Watts vs. ZIRC"))
  
lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = 0
fig_pair = df_fig_pair %>%
  ggplot(aes(x = group, y = Taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, 
       y = NULL, 
       title = "Log fold change of pairwise comparisons",
       caption = "(4mo, controls)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

fig_pair



# Sensitivity Pairs

sens_pair = tab_sens %>%
    rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    transmute(sens_pair = `Gemma - Watts`) %>%
    rownames_to_column("Taxon") %>%
    left_join(df_pair %>%
                  transmute(Taxon, 
                            diff_pair = diff_DietWatts), 
              by = "Taxon") %>%
    mutate(group = "Gemma vs. Watts") %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Gemma - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC), 
                      by = "Taxon") %>%
            mutate(group = "Gemma vs. ZIRC")
    ) %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Watts - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC_DietWatts), 
                      by = "Taxon") %>%
            mutate(group = "Watts vs. ZIRC")
    )
sens_pair$diff_pair = recode(sens_pair$diff_pair * 1, 
                             `1` = "Significant",
                             `0` = "Nonsignificant")
sens_pair$group = factor(sens_pair$group, 
                         levels = c("Gemma vs. Watts",
                                    "Gemma vs. ZIRC",
                                    "Watts vs. ZIRC"))

fig_sens_pair = sens_pair %>%
    ggplot(aes(x = Taxon, y = sens_pair, color = diff_pair)) +
    geom_point() +
    scale_color_brewer(palette = "Dark2", name = NULL) +
    facet_grid(rows = vars(group), scales = "free") +
    labs(x = NULL, y = "Sensitivity Score",
       caption = "(4mo, controls)") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
fig_sens_pair

```

#### Primary


```{r}

# Plot settings
tmp.path <- "gg_Record/Dev_4mo7moCtrl/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8,
          height = 5,
          units = "in"
          )

```

##### Gemma


```{r}

data.diffAb <- diffAb.conT0T1_Gemma

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "Timepoint4mpf", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Timepoint")) 
df_fig_plot = df_plot %>%
    filter(diff_Timepoint7mpf == 1) %>% 
    arrange(desc(lfc_Timepoint7mpf)) %>%
    mutate(direct = ifelse(lfc_Timepoint7mpf > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Timepoint7mpf, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Timepoint7mpf - se_Timepoint7mpf, ymax = lfc_Timepoint7mpf + se_Timepoint7mpf), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes between 4 and 7 months in Gemma diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[1], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    arrange(-lfc_Timepoint7mpf) %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-DietGemma_4-7moCtrl."
                                        ),
                              ext),  # pdf or png
                    )
})



df_fig_plot %>%
  select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
  arrange(-lfc_Timepoint7mpf) %>%
  select(Taxon)
```

##### Watts


```{r}

data.diffAb <- diffAb.conT0T1_Watts

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "Timepoint4mpf", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Timepoint")) 
df_fig_plot = df_plot %>%
    filter(diff_Timepoint7mpf == 1) %>% 
    arrange(desc(lfc_Timepoint7mpf)) %>%
    mutate(direct = ifelse(lfc_Timepoint7mpf > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Timepoint7mpf, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Timepoint7mpf - se_Timepoint7mpf, ymax = lfc_Timepoint7mpf + se_Timepoint7mpf), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes between 4 and 7 months in Watts diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))
         ) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[2], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    arrange(-lfc_Timepoint7mpf) %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-DietWatts_4-7moCtrl."
                                        ),
                              ext),  # pdf or png
                    )
})


df_fig_plot %>%
  select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
  arrange(-lfc_Timepoint7mpf) %>%
  select(Taxon)

```

##### ZIRC


```{r}

data.diffAb <- diffAb.conT0T1_ZIRC

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "Timepoint4mpf", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Timepoint")) 

df_fig_plot = df_plot %>%
    filter(diff_Timepoint7mpf == 1) %>% 
    arrange(desc(lfc_Timepoint7mpf)) %>%
    mutate(direct = ifelse(lfc_Timepoint7mpf > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Timepoint7mpf, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Timepoint7mpf - se_Timepoint7mpf, ymax = lfc_Timepoint7mpf + se_Timepoint7mpf), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes between 4 and 7 months in ZIRC diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[3], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    arrange(-lfc_Timepoint7mpf) %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-DietZIRC_4-7moCtrl."
                                        ),
                              ext),  # pdf or png
                    )
})


df_fig_plot %>%
  select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
  arrange(-lfc_Timepoint7mpf) %>%
  select(Taxon)

```

##### Time


```{r}

data.diffAb <- diffAb.conT0T1_Time

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "Timepoint4mpf", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Timepoint")) 
df_fig_plot = df_plot %>%
    filter(diff_Timepoint7mpf == 1) %>% 
    arrange(desc(lfc_Timepoint7mpf)) %>%
    mutate(direct = ifelse(lfc_Timepoint7mpf > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Timepoint7mpf, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Timepoint7mpf - se_Timepoint7mpf, ymax = lfc_Timepoint7mpf + se_Timepoint7mpf), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes between 4 and 7 months across all diets",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Time[2], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    arrange(-lfc_Timepoint7mpf) %>%
    select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-Time_4-7moCtrl."
                                        ),
                              ext),  # pdf or png
                    )
})


df_fig_plot %>%
  select(Taxon, lfc_Timepoint7mpf, diff_Timepoint7mpf, direct) %>%
  arrange(-lfc_Timepoint7mpf) %>%
  select(Taxon)


```


##### Diet:Time

```{r}

data.diffAb <- diffAb.conT0T1_DietTime
tax.agg = tax.agg = aggregate_taxa(ps.obj, tax.level)
tax.data = taxa.data.table(tax.agg)
data <- data %>%
  mutate(Diet.Time = paste0(Diet,".",Timepoint), .after = Age)

res_prim <- data.diffAb$res


df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "Diet.TimeGemma.4mpf", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Diet.Time")) 



df_fig_plot = df_plot %>%
    filter((diff_Diet.TimeGemma.7mpf == 1 & 
              diff_Diet.TimeGemma.4mpf == 0 & 
              diff_Diet.TimeWatts.7mpf == 0 & 
              diff_Diet.TimeWatts.4mpf == 0 & 
              diff_Diet.TimeZIRC.7mpf == 0 & 
              diff_Diet.TimeZIRC.4mpf == 0) | 
           (diff_Diet.TimeWatts.7mpf == 1 & 
              diff_Diet.TimeGemma.4mpf == 0 & 
              diff_Diet.TimeGemma.7mpf == 0 & 
              diff_Diet.TimeWatts.4mpf == 0 & 
              # diff_Diet.TimeWatts.7mpf == 0 & 
              diff_Diet.TimeZIRC.4mpf == 0 & 
              diff_Diet.TimeZIRC.7mpf == 0) | 
           (diff_Diet.TimeZIRC.7mpf == 1 & 
              diff_Diet.TimeGemma.4mpf == 0 & 
              diff_Diet.TimeGemma.7mpf == 0 & 
              diff_Diet.TimeWatts.4mpf == 0 & 
              diff_Diet.TimeWatts.7mpf == 0 & 
              diff_Diet.TimeZIRC.4mpf == 0 #& 
              # diff_Diet.TimeZIRC.7mpf == 0
              ) 
           ) %>%
    mutate(lfc_Diet.TimeGemma.7mpf = ifelse(diff_Diet.TimeGemma.7mpf == 1, 
                                   lfc_Diet.TimeGemma.7mpf, 0),
           lfc_Diet.TimeWatts.7mpf = ifelse(diff_Diet.TimeWatts.7mpf == 1, 
                             lfc_Diet.TimeWatts.7mpf, 0),
           lfc_Diet.TimeZIRC.7mpf = ifelse(diff_Diet.TimeZIRC.7mpf == 1, 
                             lfc_Diet.TimeZIRC.7mpf, 0)) %>%
    transmute(Taxon, 
              # `Gemma (4 vs 7 mpf)` = round(lfc_Diet.TimeGemma.7mpf, 2),
              # `Watts (4 vs 7 mpf)` = round(lfc_Diet.TimeWatts.7mpf, 2),
              # `ZIRC (4 vs 7 mpf)` = round(lfc_Diet.TimeZIRC.7mpf, 2)
              `Gemma (7 mpf)` = round(lfc_Diet.TimeGemma.7mpf, 2),
              `Watts (7 mpf)` = round(lfc_Diet.TimeWatts.7mpf, 2),
              `ZIRC (7 mpf)` = round(lfc_Diet.TimeZIRC.7mpf, 2)
              ) %>%
    pivot_longer(cols = `Gemma (7 mpf)`:`Watts (7 mpf)`:`ZIRC (7 mpf)`, 
                 names_to = "group", values_to = "value") %>%
    arrange(Taxon)
  
lo = floor(min(df_fig_plot$value))
up = ceiling(max(df_fig_plot$value))
mid = (lo + up)/2
fig_plot = df_fig_plot %>%
  ggplot(aes(x = group, y = Taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = "Log fold changes of uniquely abundant taxa across diets at 7mpf") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
fig_plot

```


##### Body Condition Score

No significantly differentially abundant taxa across all diets and body condition score at genus level


```{r}

data.diffAb <- diffAb.conT0T1_DietBCS

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Body.Condition.Score")) 
df_fig_plot = df_plot %>%
    filter(diff_Body.Condition.Score == 1) %>% 
    arrange(desc(lfc_Body.Condition.Score)) %>%
    mutate(direct = ifelse(lfc_Body.Condition.Score > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Body.Condition.Score, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Body.Condition.Score - se_Body.Condition.Score, ymax = lfc_Body.Condition.Score + se_Body.Condition.Score), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "ANCOM-BC2: Log fold changes as one unit increases of Body Condition Score across all diets") + 
    scale_fill_manual(name = NULL, values = c(col.Diet[1], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot



df_fig_plot %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  arrange(-lfc_Body.Condition.Score) %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Log fold changes as one unit increases of Body Condition Score across all diets")) %>%
  autofit()


df_fig_plot %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  arrange(-lfc_Body.Condition.Score) %>%
  select(Taxon)

```


##### BCS (ZIRC)

No significantly abundant taxa within ZIRC diet that associate with body condition score at genus level

```{r}

data.diffAb <- diffAb.conT0T1_ZIRCBCS_Phylum

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    # rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Body.Condition.Score")) 
df_fig_plot = df_plot %>%
    filter(diff_Body.Condition.Score == 1) %>% 
    arrange(desc(lfc_Body.Condition.Score)) %>%
    mutate(direct = ifelse(lfc_Body.Condition.Score > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_Body.Condition.Score, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_Body.Condition.Score - se_Body.Condition.Score, ymax = lfc_Body.Condition.Score + se_Body.Condition.Score), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "ANCOM-BC2: Log fold changes as one unit increases of Body Condition Score across all diets") + 
    scale_fill_manual(name = NULL, values = c(col.Diet[1], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot



df_fig_plot %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  arrange(-lfc_Body.Condition.Score) %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Log fold changes as one unit increases of Body Condition Score across all diets")) %>%
  autofit()


df_fig_plot %>%
  select(Taxon, lfc_Body.Condition.Score, diff_Body.Condition.Score, direct) %>%
  arrange(-lfc_Body.Condition.Score) %>%
  select(Taxon)

```




## Pathogen Exposure

```{r}

data <- df.all
data.alpha <- dt.alphaPlus.all.melt
data.beta <- df.T1
data.beta2 <- df.all # Includes pre-exposure fish
ps.obj <- ps.all
dist <- distList.T1
dist2 <- distList.all



# Relevel
levels(data$PrePostExp) <- factor(levels(data$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data$PrePostExp <- relevel(factor(data$PrePostExp), ref = "Pre-exposure")

levels(data.alpha$PrePostExp) <- factor(levels(data.alpha$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data.alpha$PrePostExp <- relevel(factor(data.alpha$PrePostExp), ref = "Pre-exposure")

levels(data.beta$PrePostExp) <- factor(levels(data.beta$PrePostExp), levels = c("Exposed", "Unexposed"))
data.beta$PrePostExp <- relevel(factor(data.beta$PrePostExp), ref = "Unexposed")

levels(data.beta2$PrePostExp) <- factor(levels(data.beta2$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data.beta2$PrePostExp <- relevel(factor(data.beta2$PrePostExp), ref = "Pre-exposure")

levels(sample_data(ps.obj)$PrePostExp) <- factor(levels(sample_data(ps.obj)$PrePostExp),levels = c("Pre-exposure", "Unexposed", "Exposed"))
sample_data(ps.obj)$PrePostExp <- relevel(factor(sample_data(ps.obj)$PrePostExp), ref = "Pre-exposure")
# 
# levels(data.da$PrePostExp) <- factor(levels(data.da$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
# data.da$PrePostExp <- relevel(factor(data.da$PrePostExp), ref = "Pre-exposure")



```

### (SM) Infection

```{r}
data <- data %>%
  # filter(PrePostExp == "Exposed") %>%
  mutate(Pathology.Results = 
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           ))

data.alpha <- data.alpha %>%
  # filter(PrePostExp == "Exposed") %>%
  mutate(Pathology.Results = 
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           ))

data.beta <- data.alpha %>%
  # filter(PrePostExp == "Exposed") %>%
  mutate(Pathology.Results = 
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           ))

sample_data(ps.obj) <- sample.data.frame(ps.obj) %>%
  # filter(PrePostExp == "Exposed") %>%
  mutate(Pathology.Results = 
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           ))



```


```{r}

# Plot settings
tmp.path <- "gg_Record/Exposure/Infection"
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Infection"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Infection ~ Diet

```{r}
# Check counts
data %>%
  filter(PrePostExp == "Exposed" & Sex == "M") %>%
  mutate(Pathology.Results =
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           )) %>%
  group_by(Pathology.Results, Diet) %>%
  count(name = "Count")


# Manually enter counts into a table
xtab <- as.table(rbind(c(8, 6), c(8,7), c(12, 3)))
dimnames(xtab) <- list(
  Diet = c("Gemma", "Watts", "ZIRC"),
  Pathology.Results = c("Positive", "Negative")
)
xtab

stat.test <- pairwise_fisher_test(xtab, detailed = TRUE, p.adjust.method = "BH")

data %>%
  filter(PrePostExp == "Exposed") %>%
  # mutate(Pathology.Results = 
  #          case_when(
  #            Pathology.Results == "negative" ~ "Negative",
  #            Pathology.Results == "positive" ~ "Positive",
  #            Pathology.Results == "lumen only" ~ "Positive"
  #          )) %>%
  group_by(Pathology.Results, Diet) %>%
  count(name = "Count") %>%
  pivot_wider(data = ., names_from = Pathology.Results, values_from = Count) %>%
  group_by(Diet) %>%
  summarize(Proportion = Positive/(Negative + Positive)) %>%
  ggplot(aes(x = Diet, y = Proportion)) +
  geom_bar(aes(fill = Diet), stat = "identity", position = position_dodge2(preserve = "single"), width = .9) +
  # facet_grid(. ~ Diet) +
  scale_fill_manual(values = pal.Dark2) +
  labs(
    title = "Proportion of positive infections",
    caption = "7mo, exposed",
    x = "Diet",
    y = "Proportion"
  ) +
  ggpubr::stat_pvalue_manual(stat.test, 
                             label = "p.adj.signif", 
                             size = 6,
                             bracket.size = 1,
                             y.position = c(.75, .9, 1.05)) +
  geom_text(
    stat = "identity",
    aes(label = round(Proportion, 3)),
    size = 6,
    vjust = 2
  ) +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 6), 
                     limits = c(0, 1.1)) + 
  theme(legend.position = "none")

stat.test %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = c(4:7, 10), digits = 3) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Pairwise Fisher Test. p. adj: BH. Pathology.Results ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "PairwiseFisherTest_PathResults-Diet_7moExp.png"))

```

Chi-Square

```{r}

data %>%
  filter(PrePostExp == "Exposed") %>%
  mutate(Pathology.Results =
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           )) %>%
  group_by(Pathology.Results, Diet) %>%
  count(name = "Count")

data %>% 
  filter(PrePostExp == "Exposed" & Sex == "M") %>%
  mutate(Pathology.Results =
         case_when(
           Pathology.Results == "negative" ~ "Negative",
           Pathology.Results == "positive" ~ "Positive",
           Pathology.Results == "lumen only" ~ "Positive"
         )) %>%
  rownames_to_column("Fish.ID") %>%
  group_by(Fish.ID) %>% 
  distinct(Fish.ID, Pathology.Results, Diet) %>%
  ungroup %>%
  summarize(method = chisq.test(Pathology.Results, Diet)$method,
            statistic = chisq.test(Pathology.Results, Diet)$statistic,
            parameter = chisq.test(Pathology.Results, Diet)$parameter,
            p.value = chisq.test(Pathology.Results, Diet)$p.value
            )

```
Kruskal-Wallis

```{r}
data %>%
  filter(PrePostExp == "Exposed" 
         # & Sex == "M"
         ) %>%
  mutate(Pathology.Results =
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           )) %>%
  group_by(Pathology.Results, Diet, Sex) %>%
  count(name = "Count") %>%
  glm(formula = Count ~ Diet + Sex + Pathology.Results, family = "poisson") %>% 
  Anova(type = 2)
  summary()

```



GLM Poisson

```{r}
data %>%
  filter(PrePostExp == "Exposed" 
         # & Sex == "M"
         ) %>%
  mutate(Pathology.Results =
           case_when(
             Pathology.Results == "negative" ~ "Negative",
             Pathology.Results == "positive" ~ "Positive",
             Pathology.Results == "lumen only" ~ "Positive"
           )) %>%
  group_by(Pathology.Results, Diet, Sex) %>%
  count(name = "Count") %>%
  glm(formula = Count ~ Diet + Sex + Pathology.Results, family = "poisson") %>% 
  Anova(type = 2)
  summary()


```



##### Body Condition Score

```{r}


data %>% 
  filter(Timepoint == "7mpf") %>%
  lm(data = ., formula = Body.Condition.Score ~ Pathology.Results*Diet, na.action = "na.exclude") %>%
  anova() %>%
  tidy() %>%
    mutate(sig = ifelse(p.value <= 0.05, "*", ""))%>% 
  flextable() %>%
  align(align = "right") %>%
  colformat_double( digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.value" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Diet*Pathology.Results")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "LM_BCS-DietPath_7mo.png"))


data %>% 
  filter(Timepoint == "7mpf") %>%
    ggplot(aes(x = Pathology.Results, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet) +
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      # caption = "",
      x = "Diet",
      y = "Body Condition Score"
    ) 




```


##### Alpha Diversity


```{r Path-Alpha-Exp}

# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Pathology.Results*Diet",
       data = subset(data.alpha, Alpha.Metric == alpha & PrePostExp == "Exposed"),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet*Pathology), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-DietPath_Exp7mo.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    # hline(i = c(2,4), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet*Pathology), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-DietPath_Exp7mo.png"))


```


##### Beta Diversity

```{r Path-Beta-Exp}

data <- df.expFin
data.alpha <- dt.alphaPlus.expFin.melt
data.beta <- df.expFin
ps.obj <- ps.expFin
dist <- distList.expFin



# Full dbRDA models
mod <- full_dbrda_model(vars = c("Pathology.Results", "Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data.beta,
                          terms = 2,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)





stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Pathology*Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-PathDiet_Exp7mo.png"))

```








#### Physiology (PrePostExp)

```{r}
# Plot output settings
tmp.path <- "gg_Record/Diet_7moCtrl/Physiology"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

##### Diet


```{r Diet-Physio-Weight}

test <- data %>%
  # group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Diet) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")

Fig.1.a <- 
  data %>%
    ggplot(aes(x = Diet, 
               y = Weight
               )) +
    geom_boxplot(aes(fill = Diet)) +
    geom_quasirandom(size = 1) +
    # facet_grid(as.formula(paste0(facet.var.y, " ~ ", facet.var.x)), scales = "free_y") + 
    scale_fill_manual(values = pal.Dark2) +
    scale_color_manual(values = pal.Dark2) + 
    labs(
      # title = "",
      caption = "7mo, control",
      x = "Diet",
      y = "Weight (mg)"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(400, 600, 525)) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 625)) + 
  theme(legend.position = "none")


Fig.1.a

test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-Diet_7moCtrl.png"))


```



### Physiology

```{r}

tmp.path <- "gg_Record/Exposure/Physiology"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Physiology"),
          device = "png",
          width = 10,
          height = 5,
          units = "in"
          )

```

#### Body Condition Score

```{r Dev-Physio-BCS}

test <- data %>%
  # filter(Alpha.Metric == "Shannon") %>%
  group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ PrePostExp) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = PrePostExp, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = PrePostExp)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Exp) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(3, 3.3, 3.6,
                                              3, 3.3, 3.6,
                                              3.5, 3.8, 4.15)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")


test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Diet:Exposure")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_BCS-DietPrePostExp_All.png"))

```









### Alpha Diversity

#### Exposure


```{r}

tmp.path <- "gg_Record/Exposure/Alpha"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Alpha"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

```{r Path-Alpha-Exp}

tukey.test.list <- lapply(methods.alpha, function(alpha){
  summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + PrePostExp, 
                             data = data.alpha %>% filter(Alpha.Metric == alpha),
                             family = "quasibinomial"), 
                             linfct = mcp(PrePostExp = "Tukey")) ) %>% 
  tidy() %>%
  separate(contrast, c('group1', 'group2'), sep = " - ") %>%
  select(-c(null.value)) %>%
  rename(p.adj = adj.p.value) %>%
  mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                  p.adj >= 0.05 ~ "ns")) %>%
  mutate(`.y.` = "Alpha.Score", .after = 1) %>%
  mutate(metric = alpha, .before = 1)
})


plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(`.y.`, group1, group2, p.adj.signif)
})



Fig.3.a <-
  data.alpha %>%
  filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x=factor(PrePostExp, level = c("Pre-exposure", "Unexposed", "Exposed")),
               y = Alpha.Score,
               )) +
    geom_boxplot(aes(fill = PrePostExp)) +
    geom_quasirandom(size = 1) +
    # facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Exp) +
    scale_color_manual(values = col.Exp) + 
    labs(
      # title = "",
      # caption = "",
      x = "Treatment",
      y = "Alpha Score (normalized)"
    ) +
    ggpubr::stat_pvalue_manual(plot.sig.labs[["Shannon"]], 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(1, 1.1,1.2)
                               ) +
    scale_y_continuous(breaks = c(0,.2,.4,.6,.8,1), 
                       limits = c(0, 1.2)) + 
  theme(legend.position = "none")

Fig.3.a

# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ PrePostExp",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Exposure), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-PrePostExp_All.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    # hline(i = c(2,4), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Exposure), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-PrePostExp_All.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Exposure), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-PrePostExp_All.png"))

```

#### Exposure:Diets


```{r}
tmp.path <- "gg_Record/Exposure/Alpha"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Alpha"),
          device = "png",
          width = 10,
          height = 5,
          units = "in"
          )

```

```{r Path-Alpha-ExpDiets, fig.width = 10, fig.height = 5}

tukey.test.list <- lapply(methods.alpha, function(alpha){
  test <- data.alpha %>%
  filter(Alpha.Metric == alpha) %>%
  group_by(Diet) %>%
  nest(data = -Diet) %>%
  mutate(test = map(.x=data, 
                    ~summary(multcomp::glht(glm(formula = Alpha.Score ~ -1 + PrePostExp, 
                         data = .x,
                         family = "quasibinomial"), 
                         linfct = mcp(PrePostExp = "Tukey")) )%>% tidy
                    )) %>%
  unnest(test) %>%
  separate(contrast, c('group1', 'group2'), sep = " - ") %>%
  select(-c(data, null.value)) %>%
  rename(p.adj = adj.p.value) %>%
  mutate(p.adj.signif = case_when(p.adj < 0.05 ~ "*",
                                  p.adj >= 0.05 ~ "ns")) %>%
  mutate(`.y.` = "Alpha.Score", .after = 1) %>%
  arrange(Diet) %>%
  mutate(metric = alpha, .before = 1)
})


plot.sig.labs <- lapply(methods.alpha, function(alpha){ 
  tukey.test.list[[alpha]] %>% 
  as_tibble() %>% 
  select(Diet, `.y.`, group1, group2, p.adj.signif)
})

alpha.metric <- "Shannon"

Fig.3.b <-
  data.alpha %>%
  filter(Alpha.Metric == alpha.metric) %>%
    ggplot(aes(x=factor(PrePostExp, level = c("Pre-exposure", "Unexposed", "Exposed")),
               y = Alpha.Score,
               )) +
    geom_boxplot(aes(fill = PrePostExp)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Exp) +
    scale_color_manual(values = col.Exp) + 
    labs(
      # title = "",
      caption = alpha.metric,
      x = "Treatment",
      y = "Alpha Score (normalized)"
    ) +
      ggpubr::stat_pvalue_manual(plot.sig.labs[[alpha.metric]],
                               label = "p.adj.signif",
                               size = 6,
                               bracket.size = 1,
                               # y.position = 1
                               y.position = c(1, 1.1,1.2,
                                              .9, 1,1.15,
                                              1, 1.1,1.2)
                               ) +
    scale_y_continuous(breaks = c(0,.2,.4,.6,.8,1), 
                       limits = c(0, 1.2)) + 
    theme(legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = .5))

Fig.3.b

# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet*Exposure",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(6,12), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet*Exposure), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_Alpha-DietPrePostExp_All.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet*Exposure), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-DietPrePostExp_All.png"))

# Tukey's Pairwise Comparison
tukey.test.list %>%
  bind_rows() %>%
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  hline(i = c(3,6, 9, 12, 15, 18, 21, 24), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Pairwise Tukey's HSD, p.adj: Dunnett. glm(Alpha.Score ~ Diet*Exposure), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Tukeys_Alpha-DietPrePostExp_All.png"))

```


### Beta Diversity


```{r}

tmp.path <- "gg_Record/Exposure/Beta"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Beta"),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

#### Exposure

```{r Path-Beta-Exp}


# Full dbRDA models
mod <- full_dbrda_model(vars = c("PrePostExp"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data.beta,
                          terms = 1,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)



lapply(methods.beta, function(beta){
  
  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = PrePostExp )) +
      geom_point(aes(color = PrePostExp,
                     shape = Diet),
                 size = 2.5,
                 stroke = 1,
                 alpha = 1 ) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(values = pal.Set1[c(4,1,2)]) +
      scale_color_manual(values = pal.Set1[c(4,1,2)])  + 
      scale_linetype_manual(name = "Treatment", values = c("dashed", "solid")) +
      # scale_shape_manual(name = "Treatment", values = c(19, 1)) + 
      labs(title = beta,
           x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2]) + 
      theme(legend.position = "bottom")
})[1:2]

  


###
  # dt.ord.full.beta[[beta]]$sample.coords %>%
  #   ggplot(aes(x = CAP1, y = MDS1)) +
  #     stat_ellipse(aes(color = Diet, linetype = PrePostExp )) +
  #     # stat_ellipse(aes(linetype = Diet )) +
  #     geom_point(aes(color = PrePostExp,
  #                    shape = Diet),
  #                size = 2.5,
  #                alpha = 1 ) +
  #     annotate("text", 
  #              label = p.val.label,
  #              x = cap.max, y = cap.min, 
  #              size = 5, 
  #              color = "black",
  #              hjust = .95
  #     ) +
  #     scale_fill_manual(name = "Treatment", values = pal.Set1[c(1,2)]) +
  #     scale_color_manual(name = "Treatment", values = pal.Set1[c(1,2)])  + 
  #     scale_linetype_manual(name = "Diet", values = c("dashed", "solid", "dotted")) +
  #     labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
  #          y = dt.ord.full.beta[[beta]]$axes.labs[2]) + 
  #     theme(legend.position = "bottom") 
###
  


stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Exposure")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-PrePostExp_All.png"))

```

#### Diets

<!-- ```{r} -->


<!-- # Full dbRDA models -->
<!-- mod <- full_dbrda_model(vars = c("Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)" -->
<!--                           distance = dist, -->
<!--                           methods = methods.beta, -->
<!--                           names = set_names_beta, -->
<!--                           physeq = ps.obj, -->
<!--                           data = data.beta, -->
<!--                           terms = 1,  # if you want interaction terms enter 2, otherwise 1 -->
<!--                           num.cores = num.cores -->
<!--                         ) -->

<!-- anova <- beta_anova(beta.model = mod, -->
<!--                     methods = methods.beta, -->
<!--                     names = set_names_beta, -->
<!--                     num.cores = num.cores) -->


<!-- # Plot prep -->
<!-- dt.ord.full.beta <- ord_dt_list(mod, ps.obj) -->
<!-- beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta) -->
<!-- beta.axis.full <- axis_labels(dt.ord.full.beta) -->

<!-- min(dt.ord.full.beta[[beta]]$sample.coords[[3]]) -->
<!-- max(dt.ord.full.beta[[beta]]$sample.coords[[2]]) -->

<!-- Fig.3.d <- lapply(methods.beta, function(beta){ -->

<!--   p.val <- anova$p.value[anova$metric == beta][1] -->
<!--   p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val) -->
<!--   cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]]) -->
<!--   cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]]) -->

<!--   dt.ord.full.beta[[beta]]$sample.coords %>% -->
<!--     ggplot(aes(x = CAP1, y = CAP2)) + -->
<!--       stat_ellipse(aes(color = Diet )) + -->
<!--       geom_point(aes(color = Diet, -->
<!--                      shape = PrePostExp), -->
<!--                  size = 2.5, -->
<!--                  stroke = 1, -->
<!--                  alpha = 1 ) + -->
<!--       annotate("text",  -->
<!--                label = p.val.label, -->
<!--                x = cap.max, y = cap.min,  -->
<!--                size = 5,  -->
<!--                color = "black", -->
<!--                hjust = .95 -->
<!--       ) + -->
<!--       scale_fill_manual(values = pal.Dark2) + -->
<!--       scale_color_manual(values = pal.Dark2)  +  -->
<!--       scale_linetype_manual(name = "Treatment", values = c("dashed", "solid")) + -->
<!--       scale_shape_manual(name = "Treatment", values = c(19, 1)) +  -->
<!--       labs(title = beta, -->
<!--            x = dt.ord.full.beta[[beta]]$axes.labs[1],  -->
<!--            y = dt.ord.full.beta[[beta]]$axes.labs[2]) +  -->
<!--       theme(legend.position = "bottom") -->
<!-- })[1:2] -->

<!-- Fig.3.d -->

<!-- stats_table(anova) %>% -->
<!--   set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diets")) %>% -->
<!--   save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-Diet_All.png")) -->

<!-- ``` -->

#### (SM) Diets:Exposure 

```{r}


# Full dbRDA models
mod <- full_dbrda_model(vars = c("Diet", "PrePostExp"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data.beta,
                          terms = 2,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)


Supp.Fig.3.d.1 <- lapply(methods.beta, function(beta){
  
  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])


  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet, linetype = PrePostExp )) +
      geom_point(aes(color = Diet,
                     shape = PrePostExp),
                 # shape = 21,
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               # label = paste0(beta.metric, "; ", p.val.label),
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Exposure", values = col.Diet) +
      scale_color_manual(name = "Diet", values = col.Diet)  + 
      scale_shape_manual(name = "Exposure", values = c(19, 1)) +
      scale_linetype_manual(name = "Exposure", values = c("solid", "dotted")) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")

})
  
Supp.Fig.3.d.1 


Supp.Fig.3.d.2 <- lapply(methods.beta, function(beta){
  
  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])


  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = PrePostExp, linetype = Diet )) +
      geom_point(aes(color = PrePostExp,
                     shape = Diet),
                 # shape = 21,
                 size = 2.5,
                 alpha = 1) +
      annotate("text", 
               # label = paste0(beta.metric, "; ", p.val.label),
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_linetype_manual(name = "Diet", values = c("solid", "dashed", "dotted")) +
      scale_fill_manual(name = "Diet", values = col.Diet) +
      scale_color_manual(name = "Exposure", values = col.Exp[c(2,3)])  + 
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom") 

})

# Supp.Fig.3.d.1 
Supp.Fig.3.d.2 

##

stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Diets:Exposure")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-DietPrePostExp_All.png"))

```


#### (SM) Beta-Dispersion




##### Exposure

```{r}

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp <- lapply(dist2[1:2], function(beta) {
  betadisper(beta, group = data$PrePostExp)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist2[1:2], function(beta) {
  betadisper(beta, group = data$PrePostExp)  %>% boxplot(xlab = "Exposure",
                                                         col = pal.Set1[c(1,4,2)])
  
}) 

# Anova
lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
})

# Permutation table
lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
})
```

##### Diet:Exposure (all)

```{r fig.width=20}

# Add interaction
data <- data %>%
  mutate(Diet.Exp = paste0(Diet,".", PrePostExp), .after = Age)

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist2, function(beta) {
  betadisper(beta, group = data$Diet.Exp)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist2, function(beta) {
  betadisper(beta, group = data$Diet.Exp)  %>% boxplot(col = pal.Set1[c(1,4,2)])
  
}) 

# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    filter(`p-value` < 0.1) %>%
    arrange(`p-value`) %>%
    flextable() %>%
    set_caption(paste0("Beta-Dispersion Pairwise Comparisons: p-values < 0.1"))
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietPrePostExp_All.png"))
                )
   })
  })
})

```


```{r}
# beta.disp.stats[["pairwise"]][["Canberra"]] %>%
  # print(beta)
  beta.disp$bray$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    filter(`p-value` < 0.1) %>%
    arrange(`p-value`) %>%
    flextable() %>%
    set_caption(paste0("Beta-Dispersion Pairwise Comparisons: p-values < 0.1"))
```


##### Diet:Time (per diet)

###### Gemma

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "Gemma")

dist <- distList.all.Gemma

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% boxplot(col = pal.Set1[c(4,1,2)],
                                                        xlab = "Exposure (Gemma)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_Gemma.png"))
                )
   })
  })
})


```


###### Watts

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "Watts")

dist <- distList.all.Watts

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% boxplot(col = pal.Set1[c(4,1,2)],
                                                        xlab = "Exposure (Watts)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_Watts.png"))
                )
   })
  })
})
```



###### ZIRC

```{r}

# Filter for diet
tmp.data <- data %>%
  filter(Diet == "ZIRC")

dist <- distList.all.ZIRC

# Beta-dispersion Table
ord.beta <- c("bray", "canberra", "sor")
beta.disp <- list()
beta.disp.stats <- list()
beta.disp <- lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% permutest(pairwise = T, permutations = 999)
  
}) %>% setNames(ord.beta)

lapply(dist, function(beta) {
  set.seed(42)
  betadisper(beta, group = tmp.data$PrePostExp)  %>% boxplot(col = pal.Set1[c(4,1,2)],
                                                        xlab = "Exposure (ZIRC)")
}) 



# Anova
beta.disp.stats[["anova"]] <- lapply(beta.disp, function(beta) {
  beta$tab %>% 
    flextable()
}) %>% setNames(methods.beta)

# Permutation table
beta.disp.stats[["pairwise"]] <-lapply(beta.disp, function(beta) {
  # print(beta)
  beta$pairwise$permuted %>%
    tidy() %>%
    rename(Names = names,
           `p-value` = x) %>%
    flextable()
}) %>% setNames(methods.beta)

lapply(c("anova", "pairwise"), function(x){
  lapply(beta.disp.stats[x], function(test){
    lapply(methods.beta, function(beta){
  beta.disp.stats[[x]][[beta]] %>%
  save_as_image(path = file.path(path.figures, tmp.path, paste0("Disp_Beta-", x, "-",beta, "-DietTime_4-7moCtrl_ZIRC.png"))
                )
   })
  })
})
```


##### Unconstrained

```{r}

ord.beta <- c("bray", "canberra", "sor")

data.beta <- lapply(ord.beta, function(beta){
  
  tmp.ord <- ordinate(
      physeq = ps.obj, 
      method = "PCoA",  # c("DCA", "CCA", "RDA", "CAP", "DPCoA", "NMDS", "MDS", "PCoA")
      distance = beta  # c("bray", "canberra", "sor")
    )
  
  tmp.ord.data <- list()
  tmp.ord.data[[beta]] <- plot_ordination(
      physeq = ps.obj,
      ordination = tmp.ord,
      justDF = T
    )
  
}) %>% set_names(ord.beta)

# Unconstrained Plots
lapply(ord.beta, function(beta){
  
  data.beta[[beta]] %>%
    # mutate(Temp.DPE = paste0(Temperature,"°C_",DPE)) %>%
    ggplot(aes(x = Axis.1, y = Axis.2)) +
      stat_ellipse(aes(color = Diet, linetype = PrePostExp)) +
      geom_point(aes(color = Diet,
                     fill = PrePostExp),
                 shape = 21,
                 size = 2.5,
                 stroke = 1,
                 alpha = 1 ) +
      # annotate("text", 
      #          label = p.val.label,
      #          x = cap.max, y = cap.min, 
      #          size = 5, 
      #          color = "black",
      #          hjust = .95
      # ) +
      scale_fill_manual(name = "Treatment", values = pal.Set1[c(1,4,2)]) +
      scale_color_manual(name = "Diet", values = pal.Dark2)  + 
      scale_linetype_manual(name = "Treatment", values = c("solid", "dotted", "dashed")) +
      # scale_shape_manual(name = "Treatment", values = c(19, 1)) + 
      # labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
      #      y = dt.ord.full.beta[[beta]]$axes.labs[2]) + 
      theme(legend.position = "bottom")

})[1:2]


```


### Differential Abundance

```{r}

# Plot settings
tmp.path <- "gg_Record/Exposure/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 12,
          height = 10,
          units = "in"
          )

```


#### Global

##### All

```{r}

data.diffAb = diffAb.all_DietPrePostExp

tax.agg = tax.agg = aggregate_taxa(ps.obj, tax.level)
tax.data = taxa.data.table(tax.agg)

# Global

tab_w = data.diffAb$res_global[, "W", drop = FALSE]
tab_p = data.diffAb$res_global[, "p_val", drop = FALSE]
tab_q = data.diffAb$res_global[, "q_val", drop = FALSE]
tab_diff = data.diffAb$res_global[, "diff_abn", drop = FALSE]

# Log transform

samp_frac = data.diffAb$samp_frac
# Replace NA with 0
samp_frac[is.na(samp_frac)] = 0 

# Add pesudo-count (1) to avoid taking the log of 0
log_obs_abn = log(abundances(tax.agg) + 1) 

# Adjust the log observed abundances
log_obs_abn_adj = t(t(log_obs_abn) - samp_frac)

# Prep for visualization

sig_taxa = data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
  .$Taxon

df_sig = as.data.frame(t(log_obs_abn_adj[sig_taxa, ])) %>%
  tibble::rownames_to_column("Sample") %>%
  dplyr::left_join(data %>%
  tibble::rownames_to_column("Sample") %>%
                     dplyr::select(Sample, Diet, PrePostExp),
                   by = "Sample") %>%
  dplyr::filter(!is.na(Diet)) %>%
  tidyr::pivot_longer(cols = -one_of("Sample", "Diet", "PrePostExp", "Diet.Exp"), 
                      names_to = "Taxon", values_to = "value")

df_plot = df_sig %>%
  dplyr::group_by(Diet, PrePostExp, Taxon) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::filter(!str_detect(Taxon, "^Bacteria")) %>% # Filter out unclassified taxa
  dplyr::mutate(value = round(value, 2)) %>%
  dplyr::arrange(Diet)
df_plot$Taxon = factor(df_plot$Taxon, levels = sig_taxa)

# Join higher taxanomic levels
df_plot = df_plot %>%
  rename_with(~tax.level, Taxon) %>%
  left_join(., tax.data %>% dplyr::select(-last_col()), by = tax.level)

lo = floor(min(df_plot$value))
up = ceiling(max(df_plot$value))
mid = (lo + up)/2


# Plot Heat map

df_plot <- df_plot %>%
  mutate(PrePostExp = fct_relevel(PrePostExp, "Pre-exposure", "Unexposed", "Exposed"))

p_heat_plotDiet = df_plot %>%
  ggplot(aes(x = Diet, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ PrePostExp")), scales = "free", space = "free", switch = "both") +
  # facet_grid(. ~ PrePostExp, scales = "free", switch="both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(Diet, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "4 & 7 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )


p_heat_plotExp = df_plot %>%
  ggplot(aes(x = PrePostExp, y = Taxon, fill = value)) + 
  geom_tile(color = "white") +
  facet_grid(as.formula(paste0(ifelse(tax.level == "Phylum", ".", "Phylum"), "~ Diet")), scales = "free", space = "free", switch = "both") +
  # facet_grid(. ~ Diet, scales = "free", switch="both") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(PrePostExp, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, y = NULL, title = paste0("Heat map of bias-corrected log observed abundances (", tax.level ,")"),
       caption = "4 & 7 mo, control") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        strip.text.y.left = element_text(angle = 0),
        axis.text.x = element_text(size = 12)
        )


p_heat_plotDiet
p_heat_plotExp


lapply(c("pdf", "png"), function(ext){
  data.diffAb$res_global %>%
  tibble::rownames_to_column("Taxon") %>%
  dplyr::filter(diff_abn == TRUE) %>%
    arrange(Taxon) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of abundant taxa (4-7mo, all), sig taxa = ", length(sig_taxa))) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2-Exp_All."
                                      ),
                            ext),  # pdf or png
                  )
})
# save_as_image(path = file.path(path.figures, tmp.path, "ANCOMBC2-Diet_4moCtrl.png"))


df_plot %>%
  select(Diet, Taxon, value) %>%
  arrange(Diet, Taxon) %>%
  select(Taxon)


```

##### Mycobacterium

```{r}

# Plot settings
tmp.path <- "gg_Record/Exposure/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8,
          height = 5,
          units = "in"
          )

```


```{r}

df_plot <- lapply(c("Gemma", "Watts", "ZIRC"), function(DIET){
  eval(parse(text = paste0("diffAb.all_",DIET,"Exp$res"))) %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "PrePostExpExposed", .x, fixed = T)) %>%
  filter(Taxon == "Mycobacterium") %>%
  select(-Taxon) %>%
  pivot_longer(
    everything(),
    names_to = c(".value", "Variable"),
    names_sep = "_"
  ) %>%
  separate(Variable, into = c("Diet", "PrePostExp"), sep = "PrePostExp") %>%
  mutate(Diet = c(DIET)) %>%
  mutate(direct = ifelse(lfc > 0, "Positive LFC", "Negative LFC"))
}) %>% bind_rows()

df_plot <- df_plot %>%
  mutate(PrePostExp = fct_relevel(PrePostExp, "Pre-exposure", "Unexposed", "Exposed"))


## pivot longer


fig_plot = df_plot %>%
    ggplot(aes(x = PrePostExp, y = lfc, fill = PrePostExp)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             # position = position_dodge(width = 0.4)
             position = "dodge",
             # fill = c("grey", "grey",col.Diet[1], 
             #          col.Diet[2],"grey", "grey", 
             #          "grey",col.Diet[3],  col.Diet[3])
             ) +
    geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    # geom_text(aes(x = PrePostExp, y = lfc, label = ifelse(isTRUE(diff), "*", "ns"))) + 
    facet_grid(. ~ Diet) +
  geom_text(aes(x = PrePostExp, y = lfc/3, label = ifelse(diff, "x", "")), size = 12) + 
    labs(x = "Treatment", y = "Log fold change", 
         title = "Log fold changes in Mycobacterium abundance",
         caption = paste0("Exposed fish as reference group for each diet")
         ) + 
    scale_fill_manual(name = NULL, values = col.Exp[c(1,3,2)]) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 33, hjust = 1),
          legend.position = "none")

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_plot %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 3) %>%
    merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
    # hline(i = ~ , j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Summary table of Mycobacterium abundance, ref = Exposed")) %>%
    autofit() %>%
    save_as_image(path = paste0(
                            file.path(path.figures, 
                                      tmp.path, 
                                      "ANCOMBC2-Exp_All_Myco."
                                      ),
                            ext),  # pdf or png
                  )
})
# save_as_image(path = file.path(path.figures, tmp.path, "ANCOMBC2-Diet_4moCtrl.png"))


df_plot %>%
  select(Diet, Taxon, value) %>%
  arrange(Diet, Taxon) %>%
  select(Taxon)

```





#### Pairwise


```{r, fig.width=8.5, fig.height=11}

data.diffAb = diffAb.all_PrePostExp

# Dataframes 
res_pair = data.diffAb$res_pair



# Sensitivity Scores

tab_sens = data.diffAb$pseudo_sens_tab
tab_sen <- tab_sens %>%
    flextable() %>%
  align(align = "right") %>%
  colformat_double(digits = 6) %>%
  # merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC2: Sensitivity Scores")) %>%
  autofit()

# Pairwise Analysis

df_pair = res_pair %>%
    rownames_to_column("Taxon") 

df_fig_pair = df_pair %>%
    filter(diff_DietWatts == 1 | diff_DietZIRC == 1 |
               diff_DietZIRC_DietWatts == 1) %>%
    mutate(lfc_Watts = ifelse(diff_DietWatts == 1, 
                             lfc_DietWatts, 0),
           lfc_ZIRC = ifelse(diff_DietZIRC == 1, 
                                   lfc_DietZIRC, 0),
           lfc_Watts_ZIRC = ifelse(diff_DietZIRC_DietWatts == 1, 
                                        diff_DietZIRC_DietWatts, 0)) %>%
    transmute(Taxon, 
              `Gemma vs. Watts` = round(lfc_Watts, 2), 
              `Gemma vs. ZIRC` = round(lfc_ZIRC, 2),
              `Watts vs. ZIRC` = round(lfc_Watts_ZIRC, 2)
              ) %>%
    pivot_longer(cols = `Gemma vs. Watts`:`Watts vs. ZIRC`, 
                 names_to = "group", values_to = "value") %>%
    arrange(Taxon)
df_fig_pair$group = factor(df_fig_pair$group, 
                           levels = c("Gemma vs. Watts",
                                      "Gemma vs. ZIRC",
                                      "Watts vs. ZIRC"))
  
lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = 0
fig_pair = df_fig_pair %>%
  ggplot(aes(x = group, y = Taxon, fill = value)) + 
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = NULL) +
  geom_text(aes(group, Taxon, label = value), color = "black", size = 4) +
  labs(x = NULL, 
       y = NULL, 
       title = "Log fold change of pairwise comparisons",
       caption = "(4mo, controls)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

fig_pair



# Sensitivity Pairs

sens_pair = tab_sens %>%
    rename_with(~gsub("(Intercept)", "DietGemma", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    transmute(sens_pair = `Gemma - Watts`) %>%
    rownames_to_column("Taxon") %>%
    left_join(df_pair %>%
                  transmute(Taxon, 
                            diff_pair = diff_DietWatts), 
              by = "Taxon") %>%
    mutate(group = "Gemma vs. Watts") %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Gemma - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC), 
                      by = "Taxon") %>%
            mutate(group = "Gemma vs. ZIRC")
    ) %>%
    bind_rows(
        tab_sens %>%
            transmute(sens_pair = `Watts - ZIRC`) %>%
            rownames_to_column("Taxon") %>%
            left_join(df_pair %>%
                          transmute(Taxon, 
                                    diff_pair = diff_DietZIRC_DietWatts), 
                      by = "Taxon") %>%
            mutate(group = "Watts vs. ZIRC")
    )
sens_pair$diff_pair = recode(sens_pair$diff_pair * 1, 
                             `1` = "Significant",
                             `0` = "Nonsignificant")
sens_pair$group = factor(sens_pair$group, 
                         levels = c("Gemma vs. Watts",
                                    "Gemma vs. ZIRC",
                                    "Watts vs. ZIRC"))

fig_sens_pair = sens_pair %>%
    ggplot(aes(x = Taxon, y = sens_pair, color = diff_pair)) +
    geom_point() +
    scale_color_brewer(palette = "Dark2", name = NULL) +
    facet_grid(rows = vars(group), scales = "free") +
    labs(x = NULL, y = "Sensitivity Score",
       caption = "(4mo, controls)") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
fig_sens_pair

```





#### Primary

```{r}

# Plot settings
tmp.path <- "gg_Record/Exposure/DiffAb"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 8,
          height = 5,
          units = "in"
          )

```

##### Gemma


```{r}

data.diffAb <- diffAb.T1_GemmaExp

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "ExposureExposed", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Exposure")) 
df_fig_plot = df_plot %>%
    filter(diff_ExposureUnexposed == 1) %>% 
    arrange(desc(lfc_ExposureUnexposed)) %>%
    mutate(direct = ifelse(lfc_ExposureUnexposed > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))


fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_ExposureUnexposed, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_ExposureUnexposed - se_ExposureUnexposed, ymax = lfc_ExposureUnexposed + se_ExposureUnexposed), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes in Unexposed Gemma diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[1], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot

lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    arrange(-lfc_ExposureUnexposed) %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-ExpGemma_7mo."
                                        ),
                              ext),  # pdf or png
                    )
})



df_fig_plot %>%
  select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
  arrange(-lfc_ExposureUnexposed) %>%
  select(Taxon)


```

##### Watts


```{r}

data.diffAb <- diffAb.T1_WattsExp

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "ExposureExposed", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Exposure")) 
df_fig_plot = df_plot %>%
    filter(diff_ExposureUnexposed == 1) %>% 
    arrange(desc(lfc_ExposureUnexposed)) %>%
    mutate(direct = ifelse(lfc_ExposureUnexposed > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_ExposureUnexposed, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_ExposureUnexposed - se_ExposureUnexposed, ymax = lfc_ExposureUnexposed + se_ExposureUnexposed), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes in Unexposed Watts diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[2], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot

lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    arrange(-lfc_ExposureUnexposed) %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-ExpWatts_7mo."
                                        ),
                              ext),  # pdf or png
                    )
})



df_fig_plot %>%
  select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
  arrange(-lfc_ExposureUnexposed) %>%
  select(Taxon)


```


##### ZIRC


```{r}

data.diffAb <- diffAb.T1_ZIRCExp

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "ExposureExposed", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, contains("Exposure")) 
df_fig_plot = df_plot %>%
    filter(diff_ExposureUnexposed == 1) %>% 
    arrange(desc(lfc_ExposureUnexposed)) %>%
    mutate(direct = ifelse(lfc_ExposureUnexposed > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_ExposureUnexposed, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_ExposureUnexposed - se_ExposureUnexposed, ymax = lfc_ExposureUnexposed + se_ExposureUnexposed), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes in Unexposed ZIRC diet",
         caption = paste0("# sig taxa = ", nrow(df_fig_plot))) + 
    scale_fill_manual(name = NULL, values = c(col.Diet[3], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    arrange(-lfc_ExposureUnexposed) %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-ExpZIRC_7mo."
                                        ),
                              ext),  # pdf or png
                    )
})



df_fig_plot %>%
  select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
  arrange(-lfc_ExposureUnexposed) %>%
  select(Taxon)


```


##### PrePostExp


```{r}

data.diffAb <- diffAb.T1_Exp

res_prim <- data.diffAb$res

df_plot = res_prim %>%
    rownames_to_column("Taxon") %>%
    rename_with(~gsub("(Intercept)", "ExposureExposed", .x, fixed = T)) %>%
      # Source: https://community.rstudio.com/t/replace-parts-of-a-column-name/116646/2
    dplyr::select(Taxon, everything()) 
df_fig_plot = df_plot %>%
    filter(diff_ExposureUnexposed == 1 ) %>% 
    arrange(desc(lfc_ExposureUnexposed)) %>%
    mutate(direct = ifelse(lfc_ExposureUnexposed > 0, "Positive LFC", "Negative LFC"))
df_fig_plot$Taxon = factor(df_fig_plot$Taxon, levels = df_fig_plot$Taxon)
df_fig_plot$direct = factor(df_fig_plot$direct, 
                           levels = c("Positive LFC", "Negative LFC"))
  
fig_plot = df_fig_plot %>%
    ggplot(aes(x = Taxon, y = lfc_ExposureUnexposed, fill = direct)) + 
    geom_bar(stat = "identity", width = 0.7, color = "black", 
             position = position_dodge(width = 0.4)) +
    geom_errorbar(aes(ymin = lfc_ExposureUnexposed - se_ExposureUnexposed, ymax = lfc_ExposureUnexposed + se_ExposureUnexposed), 
                  width = 0.2, position = position_dodge(0.05), color = "black") + 
    labs(x = NULL, y = "Log fold change", 
         title = "Log fold changes in unexposed across all diets") + 
    scale_fill_manual(name = NULL, values = c(col.Exp[3], "grey")) +
    scale_color_discrete(name = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          axis.text.x = element_text(angle = 60, hjust = 1))

fig_plot


lapply(c("pdf", "png"), function(ext){
  df_fig_plot %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    arrange(-lfc_ExposureUnexposed) %>%
    select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
    flextable() %>%
    align(align = "right") %>%
    colformat_double(digits = 6) %>%
    # merge_v(j = 1) %>%
    set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
    # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_caption(paste0("ANCOM-BC2: Log fold change in abundance. # Sig taxa = ", nrow(df_fig_plot))) %>%
    autofit() %>%
      save_as_image(path = paste0(
                              file.path(path.figures, 
                                        tmp.path, 
                                        "ANCOMBC2-ExpAllDiets_7mo."
                                        ),
                              ext),  # pdf or png
                    )
})



df_fig_plot %>%
  select(Taxon, lfc_ExposureUnexposed, diff_ExposureUnexposed, direct) %>%
  arrange(-lfc_ExposureUnexposed) %>%
  select(Taxon)


```

#### OLD



```{r}

res_global.EXP %>%
  tibble::rownames_to_column("Taxon") %>%
  filter(Taxon == "Mycobacterium") %>% 
  flextable() %>%
  align(j = 1:5, align = "right") %>%
  colformat_double(j = 2, digits = 3) %>%
  colformat_double(j = 3:4, digits = 4) %>%
  set_formatter(values = list("p_val" = p_val_format,
                              "q_val" = p_val_format) )

```


#### (SM) Exposure:Diets

```{r}


# Gemma

data.DiffAb.Exp <- 
  lapply(c("Gemma", "Watts", "ZIRC"), function(diet){
    a <- lfc.exp.diets[[diet]][["tab_lfc"]] %>%
      tibble::rownames_to_column("Taxon") %>%
      filter(Taxon == "Mycobacterium") %>% rename(LFC = 2)
    
    b <- lfc.exp.diets[[diet]][["tab_se"]] %>%
      tibble::rownames_to_column("Taxon") %>%
      filter(Taxon == "Mycobacterium") %>% rename(SE = 2)
    
    c <- lfc.exp.diets[[diet]][["tab_p"]] %>%
      tibble::rownames_to_column("Taxon") %>%
      filter(Taxon == "Mycobacterium") %>% rename(P.value = 2)
    
    left_join(a,b, by = "Taxon") %>%
      left_join(c, by = "Taxon") %>%
      mutate(Diet = diet, .before = 1)
  }) %>% bind_rows() %>%
    dplyr::mutate(direct = ifelse(LFC > 0, "Positive LFC", "Negative LFC"))

data.DiffAb.Exp %>%
  mutate(sig = ifelse(P.value <= 0.05, "*", ""))%>% 
  flextable() %>%
  # align(j = 3:6, align = "right") %>%
  # colformat_double(j = 6:9, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("adj.p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("ANCOM-BC: Log Fold Change Abundance")) %>%
  autofit()

plot =
ggplot(data = data.DiffAb.Exp, 
           aes(x = Taxon, y = LFC, fill = Diet, color = Diet), group = Diet) + 
  geom_bar(stat = "identity", 
           position = position_dodge2(width = 1, preserve = "single"), width = .4) +
  geom_errorbar(aes(ymin = LFC - SE, ymax = LFC + SE), width = 0.4,
                position = position_dodge2(width = 1, preserve = "single"), color = "black") +
  labs(x = NULL, y = "Log fold change",
       title = paste0("Log-fold Change of Mycobacterium in Exposed Fish"),
       caption = "Relative to Unexposed fish at 7 months old") +
  scale_fill_manual(values = pal.Dark2) +
  scale_color_manual(values = pal.Dark2) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0),
        panel.grid.minor.y = element_blank(),
        # axis.text.x = element_text(angle = 60, hjust = 1)
        )

plot

```

