---
title: "Infection Analysis"
author: "Michael Sieler"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

## Do infection counts differ between the diets? 

There is a discrepancy between Mike and I's results about whether infection counts differ between the diets. They do, but it depends on how you calculation infection. After digging into the datasets Mike previously sent me on Nov 24th, 2020 and Dec 7th, 2022, I realized that we were calculating infection differently. Mike's counts are based on severity score (0 to 3), while mine are based on presence or absence of infection in the coelom, ovary, kidney or lumen. Using severity score as a metric for infection count, there are indeed signficant differences between the diets. However, when comparing presence/absence of infection between the diets the association is weak, or not significant at the 0.05 threshold. The question remains, which method (severity score or presence/absence) is best for determining differences in infection burden?

One issue I found with the severity score data is that there are 11 cases where an infection is present (e.g., in the lumen), but severity score is 0. Conversely, there are two cases (e.g., DSF 644 & 651) where infection is absent, but severity score is 1. As far as I can tell, there is no indication whether these fish were marked incorrectly as having an infection.

**Update (Dec 19, 2022):**

After discussing with Mike about how infection is counted, I've updated and reran the following script. I had previously been miscounting `lumen only` infections as `positive` and not `negative`, as Mike had been doing. This led to differences in our counts. Mike explains that `lumen only` infections cannot be verified through acid staining as `Myco` infection, therefore should not be included as positive. After rerunning the script with the updated counts, I find signficant differences in infection counts between the diets of male fish. 


```{r message=FALSE, warning=FALSE, include=FALSE}

knitr::opts_chunk$set(
  echo = T,
  cache = FALSE,
  warning = FALSE,
  message = FALSE
)

# Libraries
library(flextable)  # pretty tables
library(readxl)  # read excel files
library(coin)  # run Chi-square test
library(car)  # run Anova()

library(tidyverse)  # tidy functions

# Global variables
proj.path <- "/Users/michaelsieler/Dropbox/Mac (2)/Documents/Sharpton_Lab/Projects_Repository/Kent/ZF-Diet_Infection"

```


## Import Data

```{r}

data.microbiome <- readxl::read_excel("/Users/michaelsieler/Dropbox/Mac (2)/Documents/Sharpton_Lab/Projects_Repository/Kent/ZF-Diet_Infection/Data/Raw/OSU Diet Study Primary Excel CA072820 [Clean].xlsx")

data.full <- readxl::read_excel("/Users/michaelsieler/Dropbox/Mac (2)/Documents/Sharpton_Lab/Projects_Repository/Kent/ZF-Diet_Infection/Data/Raw/ZF_MycoDataSet.xlsx")


```

### Clean Data

```{r}
data.full <-
# test <-
  data.full %>%
    mutate(Pathology.Results = case_when(
      # Pathology.Results == "lumen only" ~ "Positive",
      Pathology.Results == "Positive" ~ "Positive",
      Pathology.Results == "Negative" ~ "Negative",
      Pathology.Results == "NA" ~ NA
    )) %>% 
  mutate(Sex = case_when(
    Sex == "M" ~ "Male",
    Sex == "F" ~ "Female"
  ))
  
  
data.microbiome <-
  data.microbiome %>%
    mutate(Pathology.Results = case_when(
      Pathology.Results == "Lumen Only" ~ "Negative",
      Pathology.Results == "Positive" ~ "Positive",
      Pathology.Results == "Negative" ~ "Negative",
      Pathology.Results == NA ~ NA
    )) %>%
  mutate(Sex = case_when(
    Sex == "M" ~ "Male",
    Sex == "F" ~ "Female"
  ))

```

```{r}

data.full
data.microbiome

```




## Infection Count Tables

### Full Dataset

#### Males and Females

```{r}

data.full %>%
  # filter(Sex == "M") %>%
  filter(Timepoint == "7mpf" & Treatment != "control") %>%
  group_by(Diet, Sex, Pathology.Results, .drop = FALSE) %>%
    # group_by(Diet, Pathology.Results) %>%
  count(name = "Count", .drop = FALSE) %>% 
  flextable() %>%
  set_caption(caption = paste0("Infected fish by diet and sex (n = ", nrow(subset(data.full, Treatment != "control" & Timepoint == "7mpf")), ")"))

```

##### Stats

###### Chi-Square

```{r}

# Create a matrix with the infection counts
infection_counts <- matrix(
  c(3, 0, 
    3, 9, 
    4, 0, 
    5, 19, 
    6, 0, 
    5, 12),
  nrow = 6, byrow = TRUE,
  dimnames = list(
    c("Gemma_Female", "Gemma_Male", "Watts_Female", "Watts_Male", "ZIRC_Female", "ZIRC_Male"),
    c("Positive", "Negative")
  )
)

infection_counts

# Run pairwise chi-square test
chisq.test(infection_counts)


```





##### Plot

```{r}

data.full %>%
  group_by(Diet, Sex) %>%
  filter(Timepoint == "7mpf" & Treatment != "control") %>%
  summarize(PercentInfected = mean(Pathology.Results == "Positive")) %>%
  ggplot(aes(x = Diet, y = PercentInfected, fill = Diet)) +
  geom_bar(stat = "identity", width = 0.5) +
    geom_text(aes(label = paste0(round(PercentInfected*100, digits = 1), "%")), 
                  vjust = 2,
                  size = 6
                  # position=position_fill(vjust=0.1)
              
              ) +
  facet_grid(. ~ Sex) +
  scale_fill_manual(values = pal.Dark2, name = "Diet") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none",
        panel.grid.minor=element_blank(),
        axis.title.x=element_blank()) +
  labs(y = "Percent Infected")

  
  # df.expFin %>%
  #   select(c(1, 6, 8, 13))
  
```


#### Males Only


```{r}

data.full %>%
  filter(Sex == "Male") %>%
  filter(Timepoint == "7mpf" & Treatment != "control") %>%
  group_by(Diet, Sex, Pathology.Results, .drop = FALSE) %>%
  count(name = "Count", .drop = FALSE) %>% 
  flextable() %>%
  set_caption(caption = paste0("Infected fish by diet and sex (n = ", nrow(subset(data.full, Sex == "Male" & Treatment != "control" & Timepoint == "7mpf")), ")"))

```

### Microbiome Subset

#### Males and Females

```{r}

data.microbiome %>%
  # filter(Sex == "M") %>%
  filter(PrePostExp == "Exposed") %>%
  group_by(Diet, Sex, Pathology.Results, .drop = FALSE) %>%
    # group_by(Diet, Pathology.Results) %>%
  count(name = "Count", .drop = FALSE) %>% 
  flextable() %>%
  set_caption(caption = paste0("Infected fish by diet and sex (n = ", nrow(subset(data.microbiome, PrePostExp == "Exposed")), ")"))

```


##### Stats

###### Chi-Square

```{r}

# Create a matrix with the infection counts
infection_counts <- matrix(
  c(3, 0, 
    3, 9, 
    4, 0, 
    5, 19, 
    6, 0, 
    5, 12),
  nrow = 6, byrow = TRUE,
  dimnames = list(
    c("Gemma_Female", "Gemma_Male", "Watts_Female", "Watts_Male", "ZIRC_Female", "ZIRC_Male"),
    c("Positive", "Negative")
  )
)

infection_counts

# Run pairwise chi-square test
chisq.test(infection_counts)


```

##### Plot

```{r}

data.microbiome %>%
  group_by(Diet, Sex) %>%
  filter(PrePostExp == "Exposed") %>%
  summarize(PercentInfected = mean(Pathology.Results == "Positive")) %>%
  ggplot(aes(x = Diet, y = PercentInfected, fill = Diet)) +
  geom_bar(stat = "identity", width = 0.5) +
    geom_text(aes(label = paste0(round(PercentInfected*100, digits = 1), "%")), 
                  vjust = 2,
                  size = 6
                  # position=position_fill(vjust=0.1)
              
              ) +
  facet_grid(. ~ Sex) +
  scale_fill_manual(values = pal.Dark2, name = "Diet") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "none",
        panel.grid.minor=element_blank(),
        axis.title.x=element_blank()) +
  labs(y = "Percent Infected")

```

#### Males Only

```{r}

data.microbiome %>%
  filter(Sex == "Male") %>%
  filter(PrePostExp == "Exposed") %>%
  group_by(Diet, Sex, Pathology.Results, .drop = FALSE) %>%
    # group_by(Diet, Pathology.Results) %>%
  count(name = "Count", .drop = FALSE) %>% 
  flextable() %>%
  set_caption(caption = paste0("Infected fish by diet and sex (n = ", nrow(subset(data.microbiome, PrePostExp == "Exposed" & Sex == "Male")), ")"))


```





\newpage

<!-- ## Statistical Tests -->

<!-- ### Chi-Square -->

<!-- #### Microbiome Subset  -->

<!-- ##### Males and Females -->

<!-- ```{r} -->


<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 6, 6, 11)  # Positive -->
<!-- n <- c( 8, 9, 4 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d) -->


<!-- ``` -->

<!-- ##### Males only -->

<!-- ```{r} -->


<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 3, 3, 6)  # Positive -->
<!-- n <- c( 8, 9, 4 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d) -->


<!-- ``` -->


<!-- #### Nov 24 -->


<!-- ##### Males and Females -->

<!-- ```{r} -->


<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 6, 9, 18)  # Positive -->
<!-- n <- c( 9, 19, 5 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d)  -->


<!-- ``` -->

<!-- ##### Males Only -->


<!-- Counts from Nov 24 spreadsheet (counting `lumen only` as positive) -->

<!-- ```{r} -->

<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 3, 5, 12 )  # Positive -->
<!-- n <- c( 9, 19, 5 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d) -->


<!-- ``` -->



<!-- #### Dec 7 -->


<!-- Mike's numbers from email -->

<!-- ```{r} -->

<!-- # Mike's numbers from his email -->
<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 3, 3, 14)  # Positive -->
<!-- n <- c( 8, 20, 4 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d) -->

<!-- ``` -->


<!-- Counts from spreadsheet -->

<!-- Note: These counts differ from Mike's email, but still return a significant result -->

<!-- ```{r} -->

<!-- # (Gemma, Watts, ZIRC) -->
<!-- p <- c( 3, 3, 12)  # Positive -->
<!-- n <- c( 9, 21, 5 )  # Negative -->

<!-- d <- rbind( p, n) -->
<!-- d <- as.table(d) -->
<!-- coin::chisq_test(d) -->

<!-- ``` -->


<!-- \newpage -->

<!-- ### GLM -->

<!-- #### Nov 24 -->


<!-- Presence/Absence -->

<!-- ```{r} -->

<!-- mod.Nov.glm <- data.Nov24 %>% -->
<!--   filter(Sex == "M") %>% -->
<!--   mutate(Infected = -->
<!--            case_when( -->
<!--              Pathology.Results == "Negative" ~ 0, -->
<!--              Pathology.Results == "Positive" ~ 1 -->
<!--            )) %>% -->
<!--     glm(formula = Infected ~ Diet, family = "binomial")  -->

<!-- mod.Nov.glm %>% summary() -->
<!-- mod.Nov.glm %>% Anova(type = 2) -->
<!-- # mod.1 %>% plot() -->

<!-- ``` -->



<!-- #### Microbiome Subset -->

<!-- ```{r} -->

<!-- mod.expFin.glm <- df.expFin %>% -->
<!--   # filter(Sex == "M") %>% -->
<!--   mutate(Infected = -->
<!--            case_when( -->
<!--              Pathology.Results == "Negative" ~ 0, -->
<!--              Pathology.Results == "Positive" ~ 1 -->
<!--            )) %>% -->
<!--     glm(formula = Infected ~ Diet, family = "binomial")  -->

<!-- mod.expFin.glm %>% summary() -->
<!-- mod.expFin.glm %>% Anova(type = 2) -->
<!-- # mod.1 %>% plot() -->

<!-- ``` -->




## Body condition Score

### Full Dataset



```{r}

data.full %>%
  filter(Timepoint == "7mpf" & Treatment != "control" & Sex == "Male") %>%
  mutate(Infected =
           case_when(
             Pathology.Results == "Negative" ~ 0,
             Pathology.Results == "Positive" ~ 1
           )) %>%
    glm(formula = Infected ~ Body.Condition.Score*Diet, family = "binomial")  %>% 
  # summary() %>% 
  tidy() %>% 
  flextable() %>%
  colformat_double(j = 2:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  # hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("Full data set, Males Only: glm(nfected ~ Body.Condition.Score*Diet), family = guassian)")) 
  
  # Anova(type = 2)

```

