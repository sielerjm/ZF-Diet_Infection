---
title: "Diet_4mo_Physiology"
author: "Michael Sieler"
date: "2022-12-09"
output: html_document
---

This document contains analyses related to the 4 and 7 month sampling timepoints comparing pathogen exposed fish fed the three diets. 


```{r}

knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE, 
  # fig.width = 5, fig.height = 5,
  dpi = 300
)



```


## Global Variables

This chunk of code grabs the relevant data frames/tables generated from the `microbiomeProcessing.R` script for analysis.

```{r}

data <- df.all
data.alpha <- dt.alphaPlus.all.melt
data.beta <- df.T1
data.beta2 <- df.all # Includes pre-exposure fish
ps.obj <- ps.all
dist <- distList.T1
dist2 <- distList.all



# Relevel
levels(data$PrePostExp) <- factor(levels(data$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data$PrePostExp <- relevel(factor(data$PrePostExp), ref = "Pre-exposure")

levels(data.alpha$PrePostExp) <- factor(levels(data.alpha$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data.alpha$PrePostExp <- relevel(factor(data.alpha$PrePostExp), ref = "Pre-exposure")

levels(data.beta$PrePostExp) <- factor(levels(data.beta$PrePostExp), levels = c("Exposed", "Unexposed"))
data.beta$PrePostExp <- relevel(factor(data.beta$PrePostExp), ref = "Unexposed")

levels(data.beta2$PrePostExp) <- factor(levels(data.beta2$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
data.beta2$PrePostExp <- relevel(factor(data.beta2$PrePostExp), ref = "Pre-exposure")

levels(sample_data(ps.obj)$PrePostExp) <- factor(levels(sample_data(ps.obj)$PrePostExp),levels = c("Pre-exposure", "Unexposed", "Exposed"))
sample_data(ps.obj)$PrePostExp <- relevel(factor(sample_data(ps.obj)$PrePostExp), ref = "Pre-exposure")
# 
# levels(data.da$PrePostExp) <- factor(levels(data.da$PrePostExp), levels = c("Pre-exposure", "Unexposed", "Exposed"))
# data.da$PrePostExp <- relevel(factor(data.da$PrePostExp), ref = "Pre-exposure")



```


### Physiology

This chunk of code outputs figures generated in subsequent chunks into relavent figure folder.

```{r}
# Plot output settings
tmp.path <- "gg_Record/Dev_4mo7moCtrl/Physiology"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```

### Physiology

```{r}

tmp.path <- "gg_Record/Exposure/Physiology"
# Plot settings
gg_record(dir = file.path(path.figures, "gg_Record/Exposure/Physiology"),
          device = "png",
          width = 10,
          height = 5,
          units = "in"
          )

```

#### Body Condition Score

```{r Dev-Physio-BCS}

test <- data %>%
  # filter(Alpha.Metric == "Shannon") %>%
  group_by(Diet) %>%
  rstatix::wilcox_test(data =., Body.Condition.Score ~ PrePostExp) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = PrePostExp, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = PrePostExp)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Exp) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(3, 3.3, 3.6,
                                              3, 3.3, 3.6,
                                              3.5, 3.8, 4.15)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")


test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Body.Condition.Score ~ Diet:Exposure")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_BCS-DietPrePostExp_All.png"))

```