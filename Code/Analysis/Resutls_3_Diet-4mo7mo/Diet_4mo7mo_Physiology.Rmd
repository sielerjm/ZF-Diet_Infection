---
title: "Diet_4mo_Physiology"
author: "Michael Sieler"
date: "2022-12-09"
output: html_document
---

This document contains analyses related to the 4 and 7 month sampling timepoints comparing control fish fed the three diets. 


```{r}

knitr::opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE, 
  # fig.width = 5, fig.height = 5,
  dpi = 300
)



```


## Global Variables

This chunk of code grabs the relevant data frames/tables generated from the `microbiomeProcessing.R` script for analysis.

```{r}

data <- df.conT0T1
data.alpha <- dt.alphaPlus.conT0T1.melt
ps.obj <- ps.conT0T1
dist <- distList.conT0T1
# data.diffAb <- diffAb.conT0T1_DietTime
# data.diffAb <- diffAb.conT0T1_Time

levels(data.alpha$Timepoint) <- factor(levels(data.alpha$Timepoint), levels = c("4mpf", "7mpf"))
data.alpha$Timepoint <- relevel(factor(data.alpha$Timepoint), ref = "4mpf")

levels(data$Timepoint) <- factor(levels(data$Timepoint), levels = c("4mpf", "7mpf"))
data$Timepoint <- relevel(factor(data$Timepoint), ref = "4mpf")

```


### Physiology

This chunk of code outputs figures generated in subsequent chunks into relavent figure folder.

```{r}
# Plot output settings
tmp.path <- "gg_Record/Dev_4mo7moCtrl/Physiology"
gg_record(dir = file.path(path.figures, tmp.path),
          device = "png",
          width = 5,
          height = 5,
          units = "in"
          )

```


#### BCS ~ Diet*Time

```{r}

data %>% 
  lm(data = ., formula = Body.Condition.Score ~ Timepoint*Diet, na.action = "na.exclude") %>%
  anova() %>%
  tidy() %>%
    mutate(sig = ifelse(p.value <= 0.05, "*", ""))%>% 
  flextable() %>%
  align(align = "right") %>%
  colformat_double( digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.value" = p_val_format) ) %>%
  set_caption(paste0("ANOVA. p. adj: BH. Body.Condition.Score ~ Diet*Time")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "LM_BCS-DietTime_4-7mo.png"))



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Timepoint, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = col.Time) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    # ggpubr::stat_pvalue_manual(test, 
    #                            label = "p.adj.signif", 
    #                            size = 6,
    #                            bracket.size = 1,
    #                            y.position = c(3, 3.3, 3.6,
    #                                           3, 3.3, 3.6,
    #                                           3.5, 3.8, 4.15)
    #                            ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")

  
  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Diet, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Timepoint, scale = "free") +
    scale_fill_manual(values = col.Diet) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    # ggpubr::stat_pvalue_manual(test, 
    #                            label = "p.adj.signif", 
    #                            size = 6,
    #                            bracket.size = 1,
    #                            y.position = c(3, 3.3, 3.6,
    #                                           3, 3.3, 3.6,
    #                                           3.5, 3.8, 4.15)
    #                            ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(1, 4.5)) + 
  theme(legend.position = "none")


```



#### Weight ~ Diet*Time

```{r Dev-Physio-BCS}

test <- data %>%
  # filter(Alpha.Metric == "Shannon") %>%
  group_by(Diet) %>%
  rstatix::wilcox_test(data =., Weight ~ Timepoint) %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance("p.adj")



  data %>%
  # filter(Alpha.Metric == "Shannon") %>%
    ggplot(aes(x = Timepoint, 
               y = Body.Condition.Score
               )) +
    geom_boxplot(aes(fill = Timepoint)) +
    geom_quasirandom(size = 1) +
    facet_grid(. ~ Diet, scale = "free") +
    scale_fill_manual(values = pal.Dark2[c(6,4)]) +
    scale_color_manual(values = pal.Set1) + 
    labs(
      # title = "",
      # caption = "",
      x = "Time",
      y = "Body Condition Score"
    ) +
    ggpubr::stat_pvalue_manual(test, 
                               label = "p.adj.signif", 
                               size = 6,
                               bracket.size = 1,
                               y.position = c(2.65, 2.75, 3.55)
                               ) +
    scale_y_continuous(breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, 3.75)) + 
  theme(legend.position = "none")


test %>% 
  flextable() %>%
  align(j = 3:6, align = "right") %>%
  colformat_double(j = 6:7, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p" = p_val_format,
                              "p.adj" = p_val_format) ) %>%
  set_caption(paste0("Wilcoxon Test. p. adj: BH. Weight ~ Diet:Time")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "Wilcox_Weight-Diet_7moCtrl.png"))

```


#### BCS ~ Alpha Diversity

```{r}





# Stats

# Build GLM Model
mod.list <- lapply(methods.alpha, function(alpha){
  glm( formula = "Alpha.Score ~ Diet*Body.Condition.Score",
       data = subset(data.alpha, Alpha.Metric == alpha),
       family = "quasibinomial")
}) %>% setNames(methods.alpha)

# Model Output
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% 
    tidy() %>%
    mutate(metric = x, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
  flextable() %>%
  colformat_double(j = 3:5, digits = 3) %>%
  merge_v(j = 1)  %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
  hline(i = c(6, 12), j = NULL, border = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Diet*Body.Condition.Score), family = quasibinomial)")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "GLM_BCS~AlphaDiet_4-7moCtrl.png"))

# Anova
lapply(methods.alpha, function(x){
  mod.list[[x]] %>% Anova(type = 2) %>%
    tidy() %>%
    mutate(metric = x, .before = 1)  %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
}) %>% bind_rows() %>%
    flextable() %>%
    # align(j = 3:6, align = "right") %>%
    colformat_double(j = 3, digits = 3) %>%
    merge_v(j = 1) %>%
    hline(i = c(3,6), j = NULL, border = NULL, part = "body") %>%
    set_formatter(values = list("p.value" = p_val_format) ) %>%
    set_caption(paste0("ANOVA( glm(Alpha.Score ~ Diet*Body.Condition.Score), family = quasibinomial) )")) %>%
    autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_BCS~AlphaDiet_4-7moCtrl.png"))



```


#### ZIRC BCS ~ Alpha Diversity

```{r}

test.list <- lapply(methods.alpha, function(alpha){
  
  lapply(c("Gemma", "Watts", "ZIRC"), function(diet){
        glm(formula = Alpha.Score ~ Body.Condition.Score, 
               data = data.alpha %>% filter(Alpha.Metric == alpha & Diet == diet),
               family = "quasibinomial") %>% 
  Anova(type = 2) %>%
  tidy() %>% 
  mutate(term = c(paste0("Body Condition Score (", diet, ")")), 
         `.y.` = c("Alpha.Score"), 
         .before = 1,
         Diet = diet) %>%
  mutate(metric = alpha, .before = 1) %>%
      mutate(sig = ifelse(p.value <= 0.05, "*", ""))
    
  })
}) %>% bind_rows()

# test <- data.alpha %>%
#   filter(Alpha.Metric == "Shannon" & Diet == "ZIRC") %>%
#   # group_by(Diet) %>%
#   rstatix::anova_test(data =., Body.Condition.Score ~ Alpha.Score) %>%
#   rstatix::adjust_pvalue(method = "BH") %>%
#   rstatix::add_significance("p.adj")

plot.label <- lapply(methods.alpha, function(alpha){ 
    lapply(c("Gemma", "Watts", "ZIRC"), function(diet){
      paste0("F = ", round(test.list[[alpha]]$statistic, 3), "; P = ", round(test.list[[alpha]]$p.value, 3))
  })
})


## Plots need some work with the captions


  data.alpha %>%
  filter(Alpha.Metric == "Simpson" & Diet == "ZIRC") %>%
    ggplot(aes(y = Alpha.Score, 
               x = Body.Condition.Score)
           ) +
    geom_smooth(aes(color = Diet, 
                    fill = Diet), 
                method = "lm") +
    geom_point(size = 2.5) +
    # facet_grid(. ~ Diet, scale = "free") +
    annotate("text", 
               label = plot.label[["Simpson"]],
               x = 3.5, y = 0.05, 
               size = 5, 
               color = "black",
               hjust = 1
      ) +
    scale_fill_manual(values = pal.Dark2[3]) +
    scale_color_manual(values = pal.Dark2[3]) + 
    labs(
      # title = "",
      # caption = "",
      y = "Alpha Score (normalized)",
      x = "Body Condition Score"
    ) +
    theme(legend.position = "none")

  
  data.alpha %>%
  filter(Alpha.Metric == "Observed" & Diet == "Watts") %>%
    ggplot(aes(y = Alpha.Score, 
               x = Body.Condition.Score)
           ) +
    geom_smooth(aes(color = Diet, 
                    fill = Diet), 
                method = "lm") +
    geom_point(size = 2.5) +
    # facet_grid(. ~ Diet, scale = "free") +
    annotate("text", 
               label = plot.label[["Observed"]],
               x = 3.5, y = 0.05, 
               size = 5, 
               color = "black",
               hjust = 1
      ) +
    scale_fill_manual(values = pal.Dark2[3]) +
    scale_color_manual(values = pal.Dark2[3]) + 
    labs(
      # title = "",
      # caption = "",
      y = "Alpha Score (normalized)",
      x = "Body Condition Score"
    ) +
    theme(legend.position = "none")



test.list %>%
  bind_rows() %>%
  flextable() %>%
  # align(j = 3:6, align = "right") %>%
  colformat_double(j = 4, digits = 3) %>%
  merge_v(j = 1) %>%
  set_formatter(values = list("p.value" = p_val_format) ) %>%
    hline(j = NULL, part = "body") %>%
  set_caption(paste0("glm(Alpha.Score ~ Body.Condition.Score), family = quasibinomial)")) %>%
  autofit() %>%
  save_as_image(path = file.path(path.figures, tmp.path, "ANOVA_Alpha-BCS-Diet_4-7moCtrl.png"))

```

#### Beta ~ BCS*Diet


```{r Dev-Beta-BCS}

# Full dbRDA models
mod <- full_dbrda_model(vars = c("Body.Condition.Score","Diet"),  # Enter variables as a list "c(var.A, var.B, var.C)"
                          distance = dist,
                          methods = methods.beta,
                          names = set_names_beta,
                          physeq = ps.obj,
                          data = data,
                          terms = 2,  # if you want interaction terms enter 2, otherwise 1
                          num.cores = num.cores
                        )

anova <- beta_anova(beta.model = mod,
                    methods = methods.beta,
                    names = set_names_beta,
                    num.cores = num.cores)


# Plot prep
beta.metric <- 'Bray-Curtis'
dt.ord.full.beta <- ord_dt_list(mod, ps.obj)
beta.dt.full <- samp_coord_dt(dt.ord.full.beta, methods.beta)
beta.axis.full <- axis_labels(dt.ord.full.beta)



lapply(methods.beta, function(beta){

  p.val <- anova$p.value[anova$metric == beta][1]
  p.val.label <- paste0("p-value", ifelse(p.val == 0.001, " < ", " = " ), p.val)
  cap.min <- min(dt.ord.full.beta[[beta]]$sample.coords[[3]])
  cap.max <- max(dt.ord.full.beta[[beta]]$sample.coords[[2]])

  dt.ord.full.beta[[beta]]$sample.coords %>%
    ggplot(aes(x = .[[2]], y = .[[3]])) +
      stat_ellipse(aes(color = Diet )) +
      geom_point(aes(color = Diet,
                     shape = Timepoint,
                     size = Body.Condition.Score),
                 stroke = 1,
                 # size = 2.5,
                 alpha = 1) +
      annotate("text", 
               label = p.val.label,
               x = cap.max, y = cap.min, 
               size = 5, 
               color = "black",
               hjust = .95
      ) +
      scale_fill_manual(name = "Time", values = col.Diet) +
      scale_color_manual(name = "Time", values = col.Diet)  + 
      scale_shape_manual(name = "Time", values = c(19, 1)) +
      labs(x = dt.ord.full.beta[[beta]]$axes.labs[1], 
           y = dt.ord.full.beta[[beta]]$axes.labs[2],
           caption = beta) + 
      theme(legend.position = "bottom")
})

stats_table(anova) %>%
  set_caption(paste0("Distance-based redundancy analysis (dbRDA) ordination. Beta.Score ~ Body.Condition.Score*Diet")) %>%
  save_as_image(path = file.path(path.figures, tmp.path, "dbRDA_ANOVA_Beta-BCS-Diet_4-7moCtrl.png"))


```
